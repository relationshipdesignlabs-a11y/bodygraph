<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Discover your design</title>
  <style>
    :root{ --cyan:#00bcd4; --ink:#0a0f12; --muted:#64748b; }
    *{ box-sizing:border-box }
    html,body{ margin:0; height:100% }
    body{ background:#fff; color:var(--ink); font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap{ max-width:1200px; margin:0 auto; padding:24px; }
    .card{ background:#f7fbff; border:1px solid #cdeef5; border-radius:14px; padding:16px; box-shadow:0 8px 36px rgba(0,0,0,.06) }
    h1{ margin:0 0 12px; font-size:22px }
    label{ font-size:12px; color:var(--ink); font-weight:600 }
    .row{ display:flex; gap:10px; align-items:end; margin:10px 0 }
    select, input[type="text"]{
      padding:10px 12px; border:1px solid #d1e7ef; border-radius:10px; font-size:14px; outline:none
    }
    button.primary{ background:var(--cyan); color:#fff; border:0; border-radius:12px; padding:10px 14px; cursor:pointer }

    /* screens */
    #view-intake{ display:block }
    #view-chart{ display:none }
    .layout{ display:grid; grid-template-columns:260px 1fr 260px; gap:16px; align-items:start; }

    /* iframe frame */
    #chartFrameWrap{ background:#fff; border:1px solid #e6eef2; border-radius:12px; padding:8px; }
    #chartTitle{ text-align:center; font-size:15px; font-weight:800; letter-spacing:.08em; margin:6px 0 0; }
    #chartSubtitle{ text-align:center; font-size:13px; color:var(--muted); margin:0 0 8px; }
    #chartFrame{ width:100%; height:900px; border:0; display:block; }
    #chartActions{ display:flex; justify-content:center; margin-top:6px; }
    #detailsBtn{ background:#111; color:#fff; border:0; border-radius:10px; padding:8px 12px; cursor:pointer }

    /* activation columns */
    .col{ background:#fff; border:1px solid #e6eef2; border-radius:12px; padding:12px }
    .colTitle{ font-size:15px; font-weight:800; letter-spacing:.08em; margin:4px 0 10px }
    .colTitle.design{ color:var(--cyan) }
    .colTitle.person{ color:#111 }
    .actItem{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:10px; background:#fff }
    .actLeft{ display:flex; align-items:center; gap:10px }
    .actPlanet{ width:22px; text-align:center; font-size:18px; opacity:.9 }
    .actVal{ font-size:18px; font-weight:600 }
    .exal{ color:currentColor; margin-left:6px }
    .detr{ color:currentColor; margin-left:6px }

    /* first screen card width */
    #view-intake.card{ max-width:480px }

    /* autocomplete dropdown */
    .ac-wrap{ position:relative }
    .ac-list{ position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #e6eef2; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.08); z-index:20; overflow:hidden }
    .ac-item{ padding:8px 10px; cursor:pointer; font-size:14px }
    .ac-item:hover{ background:#f3f8fb }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Screen 1: birth inputs + name -->
    <div id="view-intake" class="card">
      <h1>Discover your design</h1>
      <div class="row">
        <div style="display:grid; grid-template-columns:auto 1fr; gap:8px; align-items:center;">
          <label>Name</label>
          <input id="hdName" type="text" placeholder="your name" style="width:260px">
        </div>
      </div>
      <div class="row" style="display:grid; grid-template-columns:auto 1fr 1fr 1fr; gap:8px; align-items:end;">
        <label>Birth Date</label>
        <select id="monthSel"></select>
        <select id="daySel"></select>
        <select id="yearSel"></select>
      </div>
      <div class="row">
        <div style="display:grid; grid-template-columns:auto 1fr; gap:8px; align-items:center;">
          <label>Birth Time (12h)</label>
          <div style="display:flex; gap:6px; align-items:center;">
            <select id="hh12"></select> : <select id="mm12"></select>
            <select id="ampm12"><option>AM</option><option>PM</option></select>
          </div>
        </div>
      </div>
      <div class="row">
        <div style="display:grid; grid-template-columns:auto 1fr; gap:8px; align-items:center;">
          <label>Location</label>
          <div class="ac-wrap" style="width:260px">
            <input id="hdLoc" type="text" placeholder="City, country" style="width:100%">
            <div id="acList" class="ac-list" style="display:none"></div>
          </div>
        </div>
      </div>
      <div class="row">
        <button id="generateBtn" class="primary">Generate chart</button>
        <button id="dlJsonBtn" style="margin-left:8px">Download API JSON</button>
        <span id="renderStatus" style="color:var(--muted)"></span>
      </div>
    </div>

    <!-- Screen 2: chart + name + columns -->
    <div id="view-chart" class="layout">
      <div id="designCol" class="col"><div class="colTitle design">DESIGN</div></div>
      <div>
        <div id="chartFrameWrap">
          <div id="chartTitle" style="display:none;"></div>
          <div id="chartSubtitle" style="display:none;"></div>
          <iframe id="chartFrame" src="/WORKING.html" loading="eager"></iframe>
        </div>
        <div id="chartActions">
          <button id="detailsBtn" title="View chart details">Chart details</button>
        </div>
      </div>
      <div id="personCol" class="col"><div class="colTitle person">PERSONALITY</div></div>
    </div>
  </div>

  <script>
    // Planet symbols
    const PLANET_SYM = { sun:"☉", earth:"♁", moon:"☾", mercury:"☿", venus:"♀", mars:"♂", jupiter:"♃", saturn:"♄", uranus:"♅", neptune:"♆", pluto:"♇", north_node:"☊", south_node:"☋", merucy:"☿", nepture:"♆" };
    const pad = n => String(n).padStart(2,'0');
    const formatUtc = (iso)=>{ try{ const d=new Date(iso); if(!isFinite(d)) return ''; return `${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())} ${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())} UTC`; }catch(e){ return ''; } };

    // ----- DOB + Time dropdowns (robust init)
    function initDOB(){
      try{
        const m = document.getElementById('monthSel');
        const d = document.getElementById('daySel');
        const y = document.getElementById('yearSel');
        if(m && m.options.length===0){
          const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
          months.forEach((name,idx)=>{ const o=document.createElement('option'); o.value=String(idx+1).padStart(2,'0'); o.textContent=name; m.appendChild(o); });
        }
        if(d && d.options.length===0){ for(let i=1;i<=31;i++){ const o=document.createElement('option'); o.value=String(i).padStart(2,'0'); o.textContent=String(i); d.appendChild(o); } }
        if(y && y.options.length===0){ const now=new Date().getFullYear(); for(let yr=now; yr>=1915; yr--){ const o=document.createElement('option'); o.value=String(yr); o.textContent=String(yr); y.appendChild(o); } }
        function daysInMonth(Y,M){ return new Date(Y, M, 0).getDate(); }
        function normalize(){ if(!(y&&m&&d)) return; const max=daysInMonth(parseInt(y.value||new Date().getFullYear(),10), parseInt(m.value||1,10));
          Array.from(d.options).forEach(opt=>{ opt.disabled = parseInt(opt.value,10) > max; });
          if(parseInt(d.value||'1',10) > max) d.value = String(max).padStart(2,'0');
        }
        if(m) m.addEventListener('change', normalize);
        if(y) y.addEventListener('change', normalize);
        normalize();

        // Time 12h
        const hhSel = document.getElementById('hh12');
        const mmSel = document.getElementById('mm12');
        const apSel = document.getElementById('ampm12');
        if(hhSel && hhSel.options.length===0){ for(let h=1; h<=12; h++){ const o=document.createElement('option'); o.value=String(h); o.textContent=String(h); if(h===12) o.selected=true; hhSel.appendChild(o); } }
        if(mmSel && mmSel.options.length===0){ for(let m=0; m<60; m++){ const o=document.createElement('option'); o.value=String(m).padStart(2,'0'); o.textContent=o.value; if(m===0) o.selected=true; mmSel.appendChild(o); } }
        if(apSel && !apSel.value){ apSel.value='AM'; }
      }catch(e){ console.warn(e); }
    }

    // ----- Places Autocomplete (server-assisted)
    let acToken = Math.random().toString(36).slice(2);
    let acSel = null; // {place_id, description}
    function initAutocomplete(){
      const locInput = document.getElementById('hdLoc');
      const acList = document.getElementById('acList');
      async function fetchPredictions(q){
        if(!q || q.length < 2){ acList.style.display='none'; acList.innerHTML=''; return; }
        try{
          const r = await fetch(`/api/places?q=${encodeURIComponent(q)}&session=${acToken}`);
          const js = await r.json();
          const items = Array.isArray(js.predictions) ? js.predictions : [];
          if(!items.length){ acList.style.display='none'; acList.innerHTML=''; return; }
          acList.innerHTML = items.map(p=>`<div class="ac-item" data-id="${p.place_id}">${p.description}</div>`).join('');
          acList.style.display='block';
        }catch(e){ console.warn(e); }
      }
      locInput.addEventListener('input', (e)=>{ acSel=null; fetchPredictions(e.target.value.trim()); });
      acList.addEventListener('click', async (e)=>{
        const item = e.target.closest('.ac-item'); if(!item) return;
        const pid = item.getAttribute('data-id'); const desc = item.textContent;
        locInput.value = desc; acList.style.display='none'; acSel = { place_id: pid, description: desc };
      });
      document.addEventListener('click', (e)=>{ if(!acList.contains(e.target) && e.target !== locInput){ acList.style.display='none'; } });
    }

    // ----- STRICT dignity scanner: only explicit API signals, no guessing
    function buildDignityIndexStrict(rootJson){
      const PLANETS = ["sun","earth","north_node","south_node","moon","mercury","merucy","venus","mars","jupiter","saturn","uranus","neptune","nepture","pluto"];
      const SIDES = ["design","personality"];
      const upGL = new Set(), downGL = new Set();   // gate.line tokens like '25.2'
      const upPK = new Set(), downPK = new Set();   // 'design:sun' etc.

      const normGL = s => { const m=String(s||'').match(/(\d{1,2}\.\d)/); return m?m[1]:''; };

      function scanActivations(sideKey){
        const acts = (rootJson && rootJson.activations && rootJson.activations[sideKey]) || null;
        if(!acts || typeof acts!=='object') return;
        for(const [planetKey, v] of Object.entries(acts)){
          const pk = `${sideKey}:${planetKey.toLowerCase()}`;
          let gl = '';
          if(typeof v === 'string'){
            gl = normGL(v);
            if(/\u25B2|\u25B3|\u2191/.test(v)) upGL.add(gl);         // ▲ △ ↑
            if(/\u25BC|\u25BD|\u2193/.test(v)) downGL.add(gl);       // ▼ ▽ ↓
            if(/\bexalt(ation|ed)?\b/i.test(v)) upGL.add(gl);
            if(/\bdetr(iment)?\b/i.test(v)) downGL.add(gl);
          }else if(v && typeof v==='object'){
            gl = normGL(v.value || v.gate_line || v.gate || '');
            const dig = (v.dignity || v.polarity || v.orientation || v.status || '').toString().toLowerCase();
            const ex  = v.exaltation===true || v.exalted===true || dig.includes('exalt');
            const de  = v.detriment===true || v.fall===true || v.debilitated===true || dig.includes('detr') || dig.includes('fall') || dig.includes('debil');
            if(ex && gl) upGL.add(gl); else if(ex) upPK.add(pk);
            if(de && gl) downGL.add(gl); else if(de) downPK.add(pk);
            const note = (v.note || v.text || '').toString();
            if(/\u25B2|\u25B3|\u2191/.test(note) && gl) upGL.add(gl);
            if(/\u25BC|\u25BD|\u2193/.test(note) && gl) downGL.add(gl);
          }
        }
      }

      scanActivations('design'); scanActivations('personality');

      const exTop = (rootJson && rootJson.exaltations) || null;
      const deTop = (rootJson && rootJson.detriments) || null;
      function addFromContainer(obj, sideKey, isUp){
        if(!obj) return;
        const side = obj[sideKey];
        if(Array.isArray(side)){ side.forEach(s=>{ const gl=normGL(s); if(gl) (isUp?upGL:downGL).add(gl); }); }
        else if(typeof side==='object'&&side){ for(const [k,val] of Object.entries(side)){ const gl=normGL(k); if(gl && (val===true || /^(true|exalt|detr)/i.test(String(val)))) (isUp?upGL:downGL).add(gl); } }
      }
      addFromContainer(exTop, 'design', true); addFromContainer(exTop, 'personality', true);
      addFromContainer(deTop, 'design', false); addFromContainer(deTop, 'personality', false);

      const digs = (rootJson && rootJson.dignities) || null;
      function addFromDignities(obj, sideKey){
        if(!obj) return;
        const side = obj[sideKey];
        if(!side || typeof side!=='object') return;
        for(const [k,v] of Object.entries(side)){
          const s = String(v||'').toLowerCase();
          if(s.includes('exalt')) upPK.add(`${sideKey}:${k.toLowerCase()}`);
          if(s.includes('detr') || s.includes('fall') || s.includes('debil')) downPK.add(`${sideKey}:${k.toLowerCase()}`);
        }
      }
      addFromDignities(digs, 'design'); addFromDignities(digs, 'personality');

      return {
        isUp(side, planet, gl){ return (gl && upGL.has(gl)) || (side && planet && upPK.has(side+':'+planet)); },
        isDn(side, planet, gl){ return (gl && downGL.has(gl)) || (side && planet && downPK.has(side+':'+planet)); }
      };
    }

    // ----- Activations rendering (STRICT arrows)
    function renderActivations(json){
      try{
        const dCol = document.getElementById('designCol');
        const pCol = document.getElementById('personCol');
        dCol.innerHTML = '<div class="colTitle design">DESIGN</div>';
        pCol.innerHTML = '<div class="colTitle person">PERSONALITY</div>';

        const PLANET_KEYS = ["sun","earth","north_node","south_node","moon","mercury","merucy","venus","mars","jupiter","saturn","uranus","neptune","nepture","pluto"];
        const normGL = s => { const m=String(s||'').match(/(\\d{1,2}\\.\\d)/); return m?m[1]:String(s||'').trim(); };

        const idx = buildDignityIndexStrict(json);

        function parseAct(planetKey, v){
          let gl='';
          if(typeof v==='string'){ gl = normGL(v.trim()); }
          else if (v && typeof v==='object'){ gl = normGL(v.value || v.gate_line || v.gate || ''); }
          return { gl };
        }

        function build(obj, side){
          if(!obj) return '';
          const order=["sun","earth","north_node","south_node","moon","mercury","venus","mars","jupiter","saturn","uranus","neptune","pluto"];
          const entries=Object.entries(obj).sort((a,b)=> order.indexOf(a[0].toLowerCase()) - order.indexOf(b[0].toLowerCase()));
          return entries.map(([k,v])=>{
            const key=k.toLowerCase(); const normKey = PLANET_KEYS.includes(key)?key:(key==='mercury'?'mercury': key==='neptune'?'neptune': key);
            const sym=PLANET_SYM[normKey]||""; const {gl}=parseAct(normKey,v);
            const up = idx.isUp(side, normKey, gl); const down = idx.isDn(side, normKey, gl);
            const ex = up?'<span class="exal">▲</span>':''; const de = down?'<span class="detr">▼</span>':'';
            const color = side==='design' ? 'style="color:var(--cyan)"' : 'style="color:#0a0f12"';
            return `<div class="actItem" ${color}>
                      <div class="actLeft">
                        <div class="actPlanet">${sym}</div>
                        <div style="opacity:.85;text-transform:capitalize">${key.replace('_',' ')}</div>
                      </div>
                      <div class="actVal">${gl}${ex}${de}</div>
                    </div>`;
          }).join('');
        }
        dCol.innerHTML += build(json?.activations?.design, 'design');
        pCol.innerHTML += build(json?.activations?.personality, 'personality');
      }catch(e){ console.error(e); }
    }

    // ----- Sanitize the WORKING.html (hide any dev UI) and render
    function sanitizeIframe(doc){
      const hide = ['.section','#leftPanel','#centerPanel','#gatePanel','#channelPanel','#workspace','#modeSection','#verticalGuideSection','#dataSection','#gGrid','#gGuide','#grid','#guide','#handles','#centerline','#gCenterline','#controls','#bgfile','#showGrid','#snap','#snapStep','#showGuide','#guideX','#magnet','#centerOnGuide','#save','#load','#loadSampleBtn'];
      hide.forEach(sel=> doc.querySelectorAll(sel).forEach(el=> el.style.display='none') );
      const svg = doc.querySelector('svg#svg'); if(svg){ svg.style.background='#fff'; svg.style.width='100%'; }
    }

    
    // Build request payload from inputs (shared)
    async function buildPayloadFromInputs(){
      const m = document.getElementById('monthSel').value;
      const d = document.getElementById('daySel').value;
      const y = document.getElementById('yearSel').value;
      const hh = parseInt(document.getElementById('hh12').value||'12',10);
      const mm = document.getElementById('mm12').value||'00';
      const ampm = (document.getElementById('ampm12').value||'AM');
      let HH = hh; if(ampm==='PM' && HH!==12) HH+=12; if(ampm==='AM' && HH===12) HH=0;
      const t = String(HH).padStart(2,'0') + ':' + mm;
      let loc = (document.getElementById('hdLoc').value || '').trim();
      if(acSel && acSel.place_id){
        try{
          const rr = await fetch(`/api/place-details?place_id=${encodeURIComponent(acSel.place_id)}&session=${acToken}`);
          const dj = await rr.json(); if(dj && dj.formatted_address){ loc = dj.formatted_address; }
        }catch(e){}
      }
      const monthName = n => ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][parseInt(n,10)-1];
      const birthdate = `${d}-${monthName(m)}-${String(y).slice(-2)}`;
      return { birthdate, birthtime: t, location: loc };
    }

    async function downloadApiJson(){
      try{
        const payload = await buildPayloadFromInputs();
        const res = await fetch('/api/bodygraph', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const json = await res.json();
        // Compose a plain-text file: inputs + pretty JSON
        const name = (document.getElementById('hdName').value || '').trim();
        const header = `// Inputs\\n// Name: ${name||''}\\n// Birthdate: ${payload.birthdate}\\n// Birthtime: ${payload.birthtime}\\n// Location: ${payload.location}\\n\\n`;
        const content = header + JSON.stringify(json, null, 2);
        const blob = new Blob([content], {type:'text/plain;charset=utf-8'});
        const a = document.createElement('a');
        const dt = new Date();
        const ts = dt.toISOString().replace(/[:T]/g,'-').slice(0,16);
        a.href = URL.createObjectURL(blob);
        a.download = `hdapi-output-${ts}.txt`;
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
      }catch(e){
        console.error(e);
        alert('Could not download JSON. Please check your inputs and try again.');
      }
    }


    async function generateChart(){
      const m = document.getElementById('monthSel').value;
      const d = document.getElementById('daySel').value;
      const y = document.getElementById('yearSel').value;
      const hh = parseInt(document.getElementById('hh12').value||'12',10);
      const mm = document.getElementById('mm12').value||'00';
      const ampm = (document.getElementById('ampm12').value||'AM');
      let HH = hh; if(ampm==='PM' && HH!==12) HH+=12; if(ampm==='AM' && HH===12) HH=0;
      const t = String(HH).padStart(2,'0') + ':' + mm;
      let loc = (document.getElementById('hdLoc').value || '').trim();
      const name = (document.getElementById('hdName').value || '').trim();
      const status = document.getElementById('renderStatus');
      const monthName = n => ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][parseInt(n,10)-1];
      const birthdate = `${d}-${monthName(m)}-${String(y).slice(-2)}`;

      try{
        status.textContent = 'Generating…';
        if(acSel && acSel.place_id){
          try{
            const rr = await fetch(`/api/place-details?place_id=${encodeURIComponent(acSel.place_id)}&session=${acToken}`);
            const dj = await rr.json(); if(dj && dj.formatted_address){ loc = dj.formatted_address; }
          }catch(e){}
        }

        const r = await fetch('/api/bodygraph', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ birthdate, birthtime: t, location: loc }) });
        const json = await r.json();
        try{ sessionStorage.setItem('hd_last_chart', JSON.stringify(json)); sessionStorage.setItem('hd_name', name); }catch(e){}

        document.getElementById('view-intake').style.display='none';
        document.getElementById('view-chart').style.display='grid';

        // Title + UTC
        const titleEl = document.getElementById('chartTitle');
        const subEl = document.getElementById('chartSubtitle');
        titleEl.style.display = name ? 'block' : 'none';
        titleEl.textContent = name || '';
        const utcStr = (json && json.birth_date_UTC) ? formatUtc(json.birth_date_UTC) : '';
        subEl.style.display = utcStr ? 'block' : 'none';
        subEl.textContent = utcStr;

        // Iframe render
        const frame = document.getElementById('chartFrame');
        const onLoad = () => {
          const doc = frame.contentDocument || frame.contentWindow.document;
          sanitizeIframe(doc);
          let tries=0;
          const tick = setInterval(()=>{
            try{
              if(frame.contentWindow && typeof frame.contentWindow.applyBodygraph==='function'){
                frame.contentWindow.applyBodygraph(json);
                // Auto-fit iframe height just after render
                const svg = doc.querySelector('svg#svg');
                const target = doc.querySelector('#gBody') || svg;
                if(target && target.getBBox){
                  const bbox = target.getBBox();
                  const h = Math.ceil(bbox.y + bbox.height) + 20;
                  frame.style.height = Math.max(720, h) + 'px';
                }
                clearInterval(tick);
              }
            }catch(e){}
            if(++tries>50) clearInterval(tick);
          }, 100);
          renderActivations(json);
          status.textContent='';
          frame.removeEventListener('load', onLoad);
        };
        if (frame.contentDocument && frame.contentDocument.readyState === 'complete') onLoad();
        else frame.addEventListener('load', onLoad);

      }catch(err){
        console.error(err); status.textContent='Error';
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      initDOB();
      initAutocomplete();
      document.getElementById('generateBtn').addEventListener('click', generateChart);
      document.getElementById('dlJsonBtn').addEventListener('click', downloadApiJson);
      document.getElementById('detailsBtn').addEventListener('click', ()=>{ window.location.href = '/details.html'; });
    });
  </script>
</body>
</html>
