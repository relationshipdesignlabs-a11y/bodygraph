<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Discover your design</title>
<style>
  :root{
    --bg:#ffffff; --ink:#0a0f12; --muted:#7e8b91;
    --cyan:#00d5ff;           /* Design color (centers + design channels) */
    --person:#111111;         /* Personality color (channels + gate dots) */
    --undef:#ffffff;          /* Undefined center/channel background */
    --edge:#0a0f12;           /* Center perimeter */
    --panel:#ffffff;          /* Panel bg */
    --shadow: 0 8px 36px rgba(0,0,0,.10);
  }
  html,body{margin:0;height:100%;background:#fff;color:#111;font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .container{max-width:1200px;margin:0 auto;padding:16px}
  .hidden{display:none !important}

  /* Screen 1: birth info */
  .card{background:var(--panel);border-radius:14px;padding:18px;box-shadow:var(--shadow);max-width:720px;margin:48px auto}
  h1{margin:0 0 12px;font-size:22px;letter-spacing:.2px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
  .stack{display:grid;grid-template-columns:1fr;gap:10px}
  label{font-size:12px;color:#5b6a70}
  input,select,button{appearance:none;border:1px solid #cfd6d6;background:#fff;color:#111;border-radius:10px;padding:10px 12px;font-size:14px}
  input::placeholder{color:#9aa7ad}
  button{cursor:pointer}
  .primary{background:var(--cyan);border-color:#00c0e6}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}

  /* Screen 2: chart + columns */
  .layout{display:grid;grid-template-columns:280px 1fr 280px;gap:16px;align-items:start}
  .panel{background:#fff;border:1px solid #e7ecee;border-radius:14px;padding:12px;box-shadow:var(--shadow);min-height:40px}
  .panel h3{margin:4px 0 10px;font-size:14px;letter-spacing:.2px;text-transform:uppercase;color:#54636a}
  .namebar{text-align:center;font-weight:600;font-size:16px;margin:6px 0 4px}
  .utcbar{text-align:center;color:#6a787e;font-size:12px;margin-bottom:6px}

  .frame{background:#fff;border:1px solid #e7ecee;border-radius:14px;padding:8px;box-shadow:var(--shadow)}
  .canvas{display:flex;justify-content:center;align-items:center}
  svg{width:100%;max-width:none;height:auto;background:#fff;user-select:none;touch-action:none}

  /* Columns list */
  .actlist{list-style:none;margin:0;padding:0}
  .actlist li{display:flex;justify-content:space-between;align-items:center;padding:6px 6px;border-bottom:1px dashed #e6ecef;font-size:14px}
  .actlist li:last-child{border-bottom:none}
  .pl{display:flex;gap:8px;align-items:center}
  .pl .sym{width:16px;text-align:center;font-family: "Segoe UI Symbol", "Apple Symbols", "Arial Unicode MS", sans-serif}
  .pl .val{font-variant-numeric:tabular-nums}
  .cyan{color:var(--cyan)}
  .black{color:#111}

  /* Centers */
  .center-shape{fill:var(--undef);stroke:var(--edge);stroke-width:2}
  .defined-center{fill:var(--cyan)!important;stroke:var(--edge)!important}
  .undefined-center{fill:var(--undef)!important;stroke:var(--edge)!important}

  /* Gates */
  .gate circle{fill:var(--undef);stroke:none}
  .gate text{fill:#111;font-size:10px;font-weight:600}
  .gate-defined{fill:var(--person)!important;stroke:var(--person)!important}
  .gate-text-invert{fill:#fff!important}

  /* Channels baseline: white interior with black outline, clipped at centers */
  .base-outline{fill:none;stroke:#000;pointer-events:none}
  .base-fill{fill:none;stroke:var(--undef);pointer-events:none}

  /* Half-channel painter */
  .halfstroke{fill:none;stroke-linecap:round;opacity:1}

  /* Mirrored candy stripes (black/cyan 50/50) â€” rotated per channel direction */
  .candy rect{shape-rendering:crispEdges}

  /* Center perimeter on top for crisp edge + tiny "openings" at active gates */
  .center-edge-top{fill:none;stroke:var(--edge);pointer-events:none}
  .center-open{pointer-events:none}

  /* A/B invisible handles/labels */
  #ablayer, #ablayer .abHandle, #ablayer .abLabel { display:none!important; opacity:0!important; pointer-events:none!important; }
</style>
</head>
<body>
<div class="container">

  <!-- ========== Screen 1: Birth Info ========= -->
  <div id="screen-intro" class="card">
    <h1>Discover your design</h1>
    <div class="stack">
      <div class="row">
        <label style="width:90px">Your name</label>
        <input id="inpName" type="text" placeholder="your name" style="flex:1">
      </div>

      <div class="row">
        <label style="width:90px">Birth date</label>
        <div class="grid3" style="flex:1">
          <select id="selMonth"></select>
          <select id="selDay"></select>
          <select id="selYear"></select>
        </div>
      </div>

      <div class="row">
        <label style="width:90px">Birth time</label>
        <div class="grid3" style="flex:1">
          <select id="selHour"></select>
          <select id="selMinute"></select>
          <select id="selAmPm"></select>
        </div>
        <span style="color:#6c7a80;font-size:12px">12&nbsp;h</span>
      </div>

      <div class="row">
        <label style="width:90px">Location</label>
        <input id="inpLoc" type="text" placeholder="city, country" style="flex:1">
      </div>

      <div class="row" style="justify-content:flex-end;margin-top:6px">
        <button id="btnSample" type="button">Load sample</button>
        <button id="btnGo" class="primary" type="button">Generate chart</button>
      </div>
      <div id="status" style="color:#6c7a80;font-size:12px"></div>
    </div>
  </div>

  <!-- ========== Screen 2: Chart + columns ========= -->
  <div id="screen-chart" class="hidden">
    <div class="layout">
      <aside class="panel" id="panel-design">
        <h3>Design</h3>
        <ul class="actlist cyan" id="list-design"></ul>
      </aside>

      <main>
        <div class="namebar" id="namebar"></div>
        <div class="utcbar" id="utcbar"></div>
        <div class="frame">
          <div class="canvas">
            <svg id="svg" viewBox="0 0 720 1080" preserveAspectRatio="xMidYMid meet">
              <defs>
                <mask id="clipCenters" maskUnits="userSpaceOnUse" maskContentUnits="userSpaceOnUse"></mask>
                <mask id="maskSpineOutline" maskUnits="userSpaceOnUse" maskContentUnits="userSpaceOnUse"></mask>
                <pattern id="candyTemplate" patternUnits="userSpaceOnUse" width="12" height="12" class="candy">
                  <rect width="6" height="12" fill="#111"/>
                  <rect x="6" width="6" height="12" fill="#00d5ff"/>
                </pattern>
                <filter id="hl" x="-20%" y="-20%" width="140%" height="140%">
                  <feDropShadow dx="0" dy="0" stdDeviation="4" flood-color="#8ad" flood-opacity=".6"/>
                </filter>
              </defs>
              <g id="centers"></g>
              <g id="channels"></g>
              <g id="gates"></g>
            </svg>
          </div>
        </div>
        <div style="display:flex;justify-content:center;margin:10px 0 20px">
          <button id="btnDetails" class="primary" type="button">Chart details</button>
        </div>
      </main>

      <aside class="panel" id="panel-personality">
        <h3>Personality</h3>
        <ul class="actlist black" id="list-personality"></ul>
      </aside>
    </div>
  </div>

</div>

<script>
/* ===== Form scaffolding ===== */
const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
(function initForm(){
  const selMonth = document.getElementById('selMonth');
  const selDay = document.getElementById('selDay');
  const selYear = document.getElementById('selYear');
  const selHour = document.getElementById('selHour');
  const selMinute = document.getElementById('selMinute');
  const selAmPm = document.getElementById('selAmPm');

  months.forEach((m,i)=>{
    const o=document.createElement('option'); o.value=String(i+1).padStart(2,'0'); o.textContent=m; if(m==="Sep") o.selected=true; selMonth.appendChild(o);
  });
  for(let d=1; d<=31; d++){ const o=document.createElement('option'); o.value=String(d).padStart(2,'0'); o.textContent=String(d); if(d===5) o.selected=true; selDay.appendChild(o); }
  const now = new Date(); const thisYear= now.getUTCFullYear();
  for(let y=thisYear; y>=1915; y--){ const o=document.createElement('option'); o.value=String(y); o.textContent=String(y); if(y===1990) o.selected=true; selYear.appendChild(o); }
  for(let h=1; h<=12; h++){ const o=document.createElement('option'); o.value=String(h).padStart(2,'0'); o.textContent=String(h); if(h===9) o.selected=true; selHour.appendChild(o); }
  for(let m=0; m<60; m++){ const o=document.createElement('option'); o.value=String(m).padStart(2,'0'); o.textContent=String(m).padStart(2,'0'); if(m===17) o.selected=true; selMinute.appendChild(o); }
  ["AM","PM"].forEach((p,i)=>{ const o=document.createElement('option'); o.value=p; o.textContent=p; if(p==="PM") o.selected=true; selAmPm.appendChild(o); });
})();

function toHdBirthdate(day, monthIdx1, year){
  const monName = months[parseInt(monthIdx1,10)-1];
  const yy = String(year).slice(-2);
  return `${day}-${monName}-${yy}`; // e.g. 05-Sep-90
}
function to24hTime(h12, m, ampm){
  let h = parseInt(h12,10);
  if(ampm==='AM'){ if(h===12) h=0; }
  else { if(h!==12) h+=12; }
  return `${String(h).padStart(2,'0')}:${m}`; // HH:mm
}

/* ====== Bodygraph rendering core (centers/gates/channels + integration) ====== */
const NS="http://www.w3.org/2000/svg";
const svg = document.getElementById('svg');
const gCenters = document.getElementById('centers');
const gChannels = document.getElementById('channels');
const gGates = document.getElementById('gates');

const USER_MAP = 
{"centers": [{"id": "Head", "type": "tri", "x": 295, "y": 72.31007385253906, "w": 130, "h": 110, "rot": 0, "dir": "up"}, {"id": "Ajna", "type": "tri", "x": 295, "y": 200, "w": 130, "h": 110, "rot": 0, "dir": "down"}, {"id": "Throat", "type": "rect", "x": 300, "y": 325.3846130371094, "w": 120, "h": 120, "rot": 0, "rx": 18}, {"id": "G", "type": "diamond", "x": 295, "y": 485.552734375, "w": 130, "h": 130, "rot": 45}, {"id": "Ego", "type": "tri", "x": 450.1537780761719, "y": 596.6154174804688, "w": 90, "h": 80, "rot": 152, "dir": "right"}, {"id": "Spleen", "type": "tri", "x": 81.38460540771484, "y": 661.6923217773438, "w": 120, "h": 130, "rot": 180, "dir": "left"}, {"id": "Solar", "type": "tri", "x": 524.7692260742188, "y": 659.0769653320312, "w": 120, "h": 130, "rot": 180, "dir": "right"}, {"id": "Sacral", "type": "rect", "x": 300, "y": 690.4544067382812, "w": 120, "h": 120, "rot": 0, "rx": 18}, {"id": "Root", "type": "rect", "x": 300, "y": 834.3428955078125, "w": 120, "h": 120, "rot": 0, "rx": 18}], "gates": {"1": [360, 481.23394775390625], "2": [360, 621.90234375], "3": [360, 796.8123168945312], "4": [399.69232177734375, 215.07691955566406], "5": [324.8329162597656, 705.1928100585938], "6": [552.923095703125, 723.6923217773438], "7": [323.9074401855469, 513.6246948242188], "8": [360, 432.1850891113281], "9": [392.3907470703125, 795.8869018554688], "10": [289.6658020019531, 550.6427001953125], "11": [385.91259765625, 239.69151306152344], "12": [407.19793701171875, 378.5090026855469], "13": [397.9434509277344, 515.4755859375], "14": [360, 705.1928100585938], "15": [324.8329162597656, 588.5861206054688], "16": [313.7275085449219, 354.4472961425781], "17": [334.08740234375, 240.616973877], "18": [94.15384674072266, 768.923095703125], "19": [407.19793701171875, 876.4010009765625], "20": [312.80206298828125, 382.2107849121094], "21": [514.1538696289062, 605.5384521484375], "22": [605.5384521484375, 696], "23": [360, 338.71466064453125], "24": [360, 215.07691955566406], "25": [430.3341979980469, 548.791748046875], "26": [480.9230651855469, 643.3846435546875], "27": [313.7275085449219, 772.7506713867188], "28": [120.92308044433594, 756], "29": [396.0925598144531, 705.1928100585938], "30": [631.3846435546875, 767.076904296875], "31": [323.9074401855469, 432.1850891113281], "32": [146.76922607421875, 742.1538696289062], "33": [397.8461608886719, 431.0769348144531], "34": [313.7275085449219, 732.956298828125], "35": [408.1233825683594, 349.8200378417969], "36": [632.3076782226562, 681.2307739257812], "37": [579.6923217773438, 708], "38": [313.7275085449219, 905.0899658203125], "39": [407.19793701171875, 906.0154418945312], "40": [532.6153564453125, 639.6923217773438], "41": [407.19793701171875, 936.5552978515625], "42": [328.5346984863281, 796.8123168945312], "43": [360, 283.1876525878906], "44": [146.22108459472656, 711.6709594726562], "45": [407.19793701171875, 406.2724914550781], "46": [396.0925598144531, 586.7352294921875], "47": [320.30767822265625, 214.15383911132812], "48": [94.15384674072266, 684], "49": [576.923095703125, 738.4615478515625], "50": [173.0591278076172, 727.4036254882812], "51": [497.5384521484375, 624.923095703125], "52": [392.3907470703125, 849.56298828125], "53": [328.5346984863281, 849.56298828125], "54": [313.7275085449219, 873.6246948242188], "55": [603.6923217773438, 752.3076782226562], "56": [385.91259765625, 337.7892150878906], "57": [119.07691955566406, 697.8461303710938], "58": [313.7275085449219, 937.480712890625], "59": [407.19793701171875, 771.8251953125], "60": [360, 849.56298828125], "61": [360, 167.07691955566406], "62": [334.08740234375, 338.71466064453125], "63": [399.69232177734375, 167.07691955566406], "64": [320.30767822265625, 167.07691955566406]}, "gateRadius": {"1": 12, "2": 12, "3": 12, "4": 12, "5": 12, "6": 12, "7": 12, "8": 12, "9": 12, "10": 12, "11": 12, "12": 12, "13": 12, "14": 12, "15": 12, "16": 12, "17": 12, "18": 12, "19": 12, "20": 12, "21": 12, "22": 12, "23": 12, "24": 12, "25": 12, "26": 12, "27": 12, "28": 12, "29": 12, "30": 12, "31": 12, "32": 12, "33": 12, "34": 12, "35": 12, "36": 12, "37": 12, "38": 12, "39": 12, "40": 12, "41": 12, "42": 12, "43": 12, "44": 12, "45": 12, "46": 12, "47": 12, "48": 12, "49": 12, "50": 12, "51": 12, "52": 12, "53": 12, "54": 12, "55": 12, "56": 12, "57": 12, "58": 12, "59": 12, "60": 12, "61": 12, "62": 12, "63": 12, "64": 12}, "channels": {"1-8": {"a": "1", "b": "8", "style": "orth", "w": 8, "ctrl": [380, 482.5]}, "14-2": {"a": "2", "b": "14", "style": "orth", "w": 8, "ctrl": [390, 710]}, "3-60": {"a": "3", "b": "60", "style": "orth", "w": 8, "ctrl": [210, 525]}, "4-63": {"a": "4", "b": "63", "style": "orth", "w": 8, "ctrl": [400, 205]}, "15-5": {"a": "5", "b": "15", "style": "orth", "w": 8, "ctrl": [370, 657.5]}, "6-59": {"a": "6", "b": "59", "style": "curve", "w": 8, "ctrl": [489.23077392578125, 744.923095703125]}, "31-7": {"a": "7", "b": "31", "style": "orth", "w": 8, "ctrl": [360, 505]}, "52-9": {"a": "9", "b": "52", "style": "orth", "w": 8, "ctrl": [340, 862.5]}, "10-20": {"a": "10", "b": "20", "style": "curve", "w": 8, "ctrl": [182.76922607421875, 524.3076782226562]}, "10-34": {"a": "10", "b": "34", "style": "curve", "w": 8, "ctrl": [77.53845977783203, 531.6923217773438]}, "10-57": {"a": "10", "b": "57", "style": "curve", "w": 8, "ctrl": [187.38461303710938, 507.69232177734375]}, "11-56": {"a": "11", "b": "56", "style": "orth", "w": 8, "ctrl": [390, 332.5]}, "12-22": {"a": "12", "b": "22", "style": "curve", "w": 8, "ctrl": [535.5269775390625, 531.8155517578125]}, "13-33": {"a": "13", "b": "33", "style": "orth", "w": 8, "ctrl": [340, 470]}, "16-48": {"a": "16", "b": "48", "style": "curve", "w": 8, "ctrl": [175.38461303710938, 496.6153869628906]}, "17-62": {"a": "17", "b": "62", "style": "orth", "w": 8, "ctrl": [315, 320]}, "18-58": {"a": "18", "b": "58", "style": "curve", "w": 8, "ctrl": [183.6923065185547, 887.076904296875]}, "19-49": {"a": "19", "b": "49", "style": "curve", "w": 8, "ctrl": [518.8688354492188, 827.0340576171875]}, "20-34": {"a": "20", "b": "34", "style": "curve", "w": 8, "ctrl": [136.0411376953125, 558.9717407226562]}, "20-57": {"a": "20", "b": "57", "style": "curve", "w": 8, "ctrl": [175.38461303710938, 546.4615478515625]}, "21-45": {"a": "21", "b": "45", "style": "curve", "w": 8, "ctrl": [487.403564453125, 528.11376953125]}, "23-43": {"a": "23", "b": "43", "style": "orth", "w": 8, "ctrl": [345, 332.5]}, "24-61": {"a": "24", "b": "61", "style": "orth", "w": 8, "ctrl": [360, 220]}, "25-51": {"a": "25", "b": "51", "style": "curve", "w": 9, "ctrl": [462.4615478515625, 576.923095703125]}, "26-44": {"a": "26", "b": "44", "style": "curve", "w": 8, "ctrl": [259.3846130371094, 654.4615478515625]}, "27-50": {"a": "27", "b": "50", "style": "curve", "w": 8, "ctrl": [270, 757.5]}, "28-38": {"a": "28", "b": "38", "style": "curve", "w": 8, "ctrl": [198.46153259277344, 854.7692260742188]}, "29-46": {"a": "29", "b": "46", "style": "orth", "w": 8, "ctrl": [380, 690]}, "32-54": {"a": "32", "b": "54", "style": "curve", "w": 8, "ctrl": [215.07691955566406, 834.4615478515625]}, "34-57": {"a": "34", "b": "57", "style": "curve", "w": 8, "ctrl": [156.92308044433594, 568.6153564453125]}, "35-36": {"a": "35", "b": "36", "style": "curve", "w": 8, "ctrl": [536.452392578125, 480.9158020019531]}, "37-40": {"a": "37", "b": "40", "style": "curve", "w": 8, "ctrl": [563.2904663085938, 667.856689453125]}, "39-55": {"a": "39", "b": "55", "style": "curve", "w": 8, "ctrl": [535.5269775390625, 850.1702880859375]}, "41-30": {"a": "41", "b": "30", "style": "curve", "w": 8, "ctrl": [561.2307739257812, 870.4615478515625]}, "42-53": {"a": "42", "b": "53", "style": "orth", "w": 8, "ctrl": [380, 887.5]}, "47-64": {"a": "47", "b": "64", "style": "orth", "w": 8, "ctrl": [320, 205]}}}
;

/* Center paths */
function el(n, attrs={}, parent){ const e=document.createElementNS(NS,n); for(const k in attrs) e.setAttribute(k,attrs[k]); if(parent) parent.appendChild(e); return e; }
function centerPath(c){
  const {type,x,y,w,h,rot=0,rx=18,dir='up'} = c;
  if(type==='rect') return el('rect',{x,y,width:w,height:h,rx,ry:rx,transform:`rotate(${rot} ${x+w/2} ${y+h/2})`});
  if(type==='diamond'){ const cx=x+w/2, cy=y+h/2; return el('rect',{x,y,width:w,height:h,rx:20,ry:20,transform:`rotate(${rot} ${cx} ${cy})`}); }
  if(type==='tri'){
    let pts; if(dir==='up') pts=`${x+w/2},${y} ${x+w},${y+h} ${x},${y+h}`;
    else if(dir==='down') pts=`${x},${y} ${x+w},${y} ${x+w/2},${y+h}`;
    else if(dir==='left') pts=`${x+w},${y} ${x+w},${y+h} ${x},${y+h/2}`;
    else pts=`${x},${y} ${x+w},${y+h/2} ${x},${y+h}`;
    return el('polygon',{points:pts,transform:`rotate(${rot} ${x+w/2} ${y+h/2})`});
  }
  return el('rect',{x,y,width:w,height:h,rx:10,ry:10});
}
function drawCenters(){
  gCenters.innerHTML='';
  USER_MAP.centers.forEach(c=>{
    const node=centerPath(c);
    node.classList.add('center-shape');
    node.dataset.id=c.id;
    gCenters.appendChild(node);
  });
}

/* Gates */
const GATE_TO_CENTER={'64':'Head','61':'Head','63':'Head','47':'Ajna','24':'Ajna','4':'Ajna','62':'Throat','23':'Throat','56':'Throat','35':'Throat','12':'Throat','45':'Throat','33':'Throat','31':'Throat','8':'Throat','20':'Throat','16':'Throat','1':'G','2':'G','7':'G','13':'G','10':'G','15':'G','25':'G','46':'G','21':'Ego','51':'Ego','26':'Ego','40':'Ego','48':'Spleen','57':'Spleen','44':'Spleen','50':'Spleen','32':'Spleen','28':'Spleen','18':'Spleen','55':'Solar','36':'Solar','22':'Solar','37':'Solar','6':'Solar','49':'Solar','30':'Solar','34':'Sacral','5':'Sacral','14':'Sacral','29':'Sacral','59':'Sacral','27':'Sacral','9':'Sacral','3':'Sacral','42':'Sacral','58':'Root','38':'Root','54':'Root','53':'Root','60':'Root','52':'Root','19':'Root','39':'Root','41':'Root'};
function drawGates(){
  gGates.innerHTML='';
  const ids=Object.keys(USER_MAP.gates).sort((a,b)=>+a-+b);
  ids.forEach(id=>{
    const [x,y]=USER_MAP.gates[id];
    const r=USER_MAP.gateRadius[id]||12;
    const g = el('g',{'class':'gate','data-id':id}, gGates);
    el('circle',{cx:x,cy:y,r,fill:'var(--undef)',stroke:'none'}, g);
    el('text',{x, y:y+4, 'text-anchor':'middle','font-size':'10','font-weight':'600', fill:'#111'}, g).textContent=id;
  });
}

/* Channels + helpers */
function Q(A,C,B,t){ const u=1-t; return [u*u*A[0]+2*u*t*C[0]+t*t*B[0], u*u*A[1]+2*u*t*C[1]+t*t*B[1]]; }
function sampleQuad(A,C,B,N=160){ const pts=[]; for(let i=0;i<=N;i++){ const t=i/N; pts.push(Q(A,C,B,t)); } return pts; }
function sampleOrth(A,B){ const pts=[]; const midY=(A[1]+B[1])/2; const s=40;
  for(let i=0;i<=s;i++) pts.push([A[0], A[1] + (i/s)*(midY-A[1])]);
  for(let i=1;i<=s;i++) pts.push([A[0] + (i/s)*(B[0]-A[0]), midY]);
  for(let i=1;i<=s;i++) pts.push([B[0], midY + (i/s)*(B[1]-midY)]);
  return pts;
}
function pathD(pts){ if(!pts.length) return ''; let d=`M ${pts[0][0]},${pts[0][1]}`; for(let i=1;i<pts.length;i++) d+=` L ${pts[i][0]},${pts[i][1]}`; return d; }
function pathAngle(pts){ const a=pts[0], b=pts[pts.length-1]; return Math.atan2(b[1]-a[1], b[0]-a[0])*180/Math.PI; }
function midPoint(pts){ let sx=0,sy=0; for(const p of pts){ sx+=p[0]; sy+=p[1]; } return [sx/pts.length, sy/pts.length]; }
function halfSegments(pts){ const L=[0]; for(let i=1;i<pts.length;i++){ const dx=pts[i][0]-pts[i-1][0], dy=pts[i][1]-pts[i-1][1]; L[i]=L[i-1]+Math.hypot(dx,dy); }
  const total=L[L.length-1], mid=total/2; let k=1; while(k<L.length && L[k]<mid) k++;
  const t=(mid-L[k-1])/Math.max(1e-6,(L[k]-L[k-1])); const mx=pts[k-1][0]+t*(pts[k][0]-pts[k-1][0]); const my=pts[k-1][1]+t*(pts[k][1]-pts[k-1][1]);
  const M=[mx,my]; const left=pts.slice(0,k); left.push(M); const right=[M, ...pts.slice(k)]; return [left,right];
}
let candyN=0;
function svgMidX(){ const vb=(svg.getAttribute('viewBox')||'0 0 720 1080').split(/\s+/).map(parseFloat); return vb[0]+vb[2]/2; }
function candyFor(pts){
  const deg=pathAngle(pts), m=midPoint(pts); let rot=deg+45; if(m[0]>svgMidX()) rot=180-rot;
  const defs=svg.querySelector('defs'); const tpl=document.getElementById('candyTemplate'); if(!defs||!tpl) return 'url(#candyTemplate)';
  const id=`candy-${++candyN}`; const pat=tpl.cloneNode(true); pat.id=id; pat.setAttribute('patternTransform',`rotate(${rot})`); defs.appendChild(pat); return `url(#${id})`;
}
function drawStroke(pts, style, width){
  if(!pts || pts.length<2) return;
  const p=el('path',{'class':'halfstroke','stroke-width':String(width||8),'d':pathD(pts),'stroke-linecap':'round','mask':'url(#clipCenters)'}, gChannels);
  if(style && style.type==='pattern') p.setAttribute('stroke', style.value);
  else p.setAttribute('stroke', style || '#000');
}

function ensureChannelMask(){
  const mask=document.getElementById('clipCenters'); while(mask.firstChild) mask.removeChild(mask.firstChild);
  const vb=(svg.getAttribute('viewBox')||'0 0 720 1080').split(/\s+/).map(parseFloat);
  el('rect',{x:vb[0],y:vb[1],width:vb[2],height:vb[3],fill:'white'}, mask);
  gCenters.querySelectorAll('.center-shape').forEach(s=>{
    const c=s.cloneNode(true); c.removeAttribute('class'); c.setAttribute('fill','black'); c.setAttribute('stroke','none'); mask.appendChild(c);
  });
}
function paintChannelBaseOutlined(){
  ensureChannelMask();
  gChannels.querySelectorAll('.base-outline,.base-fill').forEach(n=>n.remove());
  Object.entries(USER_MAP.channels).forEach(([id,ch])=>{
    const A=USER_MAP.gates[ch.a], B=USER_MAP.gates[ch.b]; if(!A||!B) return;
    const d = (ch.style==='curve') ? pathD(sampleQuad(A, ch.ctrl || [(A[0]+B[0])/2,(A[1]+B[1])/2], B, 64))
                                   : pathD(sampleOrth(A,B));
    const w=ch.w||8;
    el('path',{'data-id':id,'class':'base-outline','stroke-width':String(w+2),'d':d,'mask':'url(#clipCenters)'}, gChannels);
    el('path',{'data-id':id,'class':'base-fill','stroke-width':String(w),'d':d,'mask':'url(#clipCenters)'}, gChannels);
  });
}

/* Parsing + painting */
const CENTER_NAME_MAP = {"Head":"Head","Ajna":"Ajna","Throat":"Throat","G":"G","Ego":"Ego","Heart":"Ego","Spleen":"Spleen","Solar Plexus":"Solar","Solar Plexus Center":"Solar","Sacral":"Sacral","Root":"Root"};
function gnum(v){ return String(v).split('.')[0]; }
function parseApi(json){
  const centersDefined = new Set((json.centers||[]).map(n=>CENTER_NAME_MAP[n]||n));
  const D=new Set(), P=new Set();
  const d=json.activations?.design||{}, p=json.activations?.personality||{};
  Object.values(d).forEach(v=>{ if(v) D.add(gnum(v)); });
  Object.values(p).forEach(v=>{ if(v) P.add(gnum(v)); });
  const channels=new Set(); (json.channels_short||[]).forEach(s=>{ const [a,b]=String(s).split('-'); if(a&&b) channels.add([a,b].sort().join('-')); });
  return {centersDefined,D,P,channels};
}

function paintCenters(centersDefined){
  drawCenters();
  gCenters.querySelectorAll('.center-shape').forEach(node=>{
    const id=node.dataset.id;
    if(centersDefined.has(id)){ node.classList.add('defined-center'); node.classList.remove('undefined-center'); }
    else{ node.classList.add('undefined-center'); node.classList.remove('defined-center'); }
  });
  setTimeout(()=>edgeOverlayAndOpeners(),0);
}

function edgeOverlayAndOpeners(){
  const oldTop=document.getElementById('gCenterEdgeTop'); if(oldTop) oldTop.remove();
  const oldOpen=document.getElementById('gCenterOpeners'); if(oldOpen) oldOpen.remove();

  const edge=el('g',{id:'gCenterEdgeTop'}, gCenters);
  gCenters.querySelectorAll('.center-shape').forEach(s=>{
    const c=s.cloneNode(true); c.setAttribute('class','center-edge-top'); c.setAttribute('fill','none');
    const sw=s.getAttribute('stroke-width')||'2'; c.setAttribute('stroke-width',sw); edge.appendChild(c);
  });

  const openers=el('g',{id:'gCenterOpeners'}, gCenters);
  gGates.querySelectorAll('.gate').forEach(elm=>{
    const id=elm.getAttribute('data-id');
    const circle=elm.querySelector('circle'); const t=elm.querySelector('text'); if(!circle||!t) return;
    const centerId=GATE_TO_CENTER[id]; if(!centerId) return;
    const isActive = circle.classList.contains('gate-defined');
    if(!isActive) return;
    const cx=parseFloat(circle.getAttribute('cx')); const cy=parseFloat(circle.getAttribute('cy')); const r=parseFloat(circle.getAttribute('r'))||12;
    let sw=2; const refCenter=gCenters.querySelector(`.center-shape[data-id="${centerId}"]`); if(refCenter) sw=parseFloat(refCenter.getAttribute('stroke-width')||'2');
    const ropen = r + Math.max(2, sw*0.75);
    const color = getComputedStyle(document.documentElement).getPropertyValue('--undef').trim() || '#fff';
    el('circle',{cx,cy,r:ropen,fill:color,stroke:'none','class':'center-open'}, openers);
  });
}

function drawGatesStyled(D,P,centersDefined){
  drawGates();
  gGates.querySelectorAll('.gate').forEach(g=>{
    const id=g.getAttribute('data-id');
    const circles=g.querySelectorAll('circle'); const text=g.querySelector('text'); if(!circles.length) return;
    const centerId=GATE_TO_CENTER[id]||null; const centerDefined=centerId ? centersDefined.has(centerId) : false;
    const isDefined = D.has(id) || P.has(id);
    const c=circles[0]; for(let i=1;i<circles.length;i++){ circles[i].setAttribute('opacity','0'); circles[i].setAttribute('stroke','none'); }
    c.setAttribute('opacity','1');

    if(!centerDefined){
      if(isDefined){ c.classList.add('gate-defined'); c.setAttribute('fill','#111'); c.setAttribute('stroke','#111'); text.classList.add('gate-text-invert'); }
      else{ c.setAttribute('fill','var(--undef)'); c.setAttribute('stroke','none'); text.setAttribute('fill','#111'); }
      return;
    }
    if(isDefined){ c.classList.add('gate-defined'); c.setAttribute('fill','#111'); c.setAttribute('stroke','#111'); text.classList.add('gate-text-invert'); }
    else{ c.setAttribute('fill','var(--undef)'); c.setAttribute('stroke','none'); text.setAttribute('fill','#111'); }
  });
}

function styleForGate(g,D,P,pts){
  const d=D.has(String(g)), p=P.has(String(g));
  if(d && p) return {type:'pattern', value: candyFor(pts)};
  if(d) return getComputedStyle(document.documentElement).getPropertyValue('--cyan').trim() || '#00d5ff';
  if(p) return '#111';
  return null;
}

function paintNonIntegrationHalves(D,P){
  paintChannelBaseOutlined();
  const integ=new Set(['10-20','20-10','10-34','34-10','10-57','57-10','34-57','57-34','20-34','34-20','20-57','57-20']);
  Object.entries(USER_MAP.channels).forEach(([id,ch])=>{
    if(integ.has(id)) return;
    const A=USER_MAP.gates[ch.a], B=USER_MAP.gates[ch.b]; if(!A||!B) return;
    const pts = (ch.style==='curve') ? sampleQuad(A, ch.ctrl || [(A[0]+B[0])/2,(A[1]+B[1])/2], B, 120)
                                     : sampleOrth(A,B);
    const [segA,segB]=halfSegments(pts); const w=ch.w||8;
    const sA=styleForGate(ch.a,D,P,segA); if(sA) drawStroke(segA,sA,w);
    const sB=styleForGate(ch.b,D,P,segB); if(sB) drawStroke(segB,sB,w);
  });
}

/* Integration handling with fixed invisible A/B */
function getAB(){
  const ch=USER_MAP.channels[ ['20','57'].sort().join('-') ]; if(!ch) return null;
  const P20=USER_MAP.gates[ch.a], P57=USER_MAP.gates[ch.b];
  const C=ch.ctrl || [(P20[0]+P57[0])/2,(P20[1]+P57[1])/2];
  const tA=2/3, tB=1/3;
  const A=Q(P20,C,P57,tA), B=Q(P20,C,P57,tB);
  return {A,B,P20,P57,C};
}
function spine(t1,t2,N=120){
  const AB=getAB(); if(!AB) return [];
  const {P20,P57,C}=AB; const pts=[]; const steps=Math.max(2,Math.round(N*Math.abs(t2-t1)));
  for(let i=0;i<=steps;i++){ const t=t1+(i/steps)*(t2-t1); pts.push(Q(P20,C,P57,t)); } return pts;
}
function paintIntegration(D,P){
  const AB=getAB(); if(!AB) return;
  const {A,B}=AB; const P10=USER_MAP.gates['10'], P34=USER_MAP.gates['34'];
  const w=8; const has=(a,b)=> !!USER_MAP.channels[[String(a),String(b)].sort().join('-')];

  if(has(20,34)){ const seg1=spine(0.0, 1/3, 80); const s1=styleForGate(20,D,P,seg1); if(s1) drawStroke(seg1,s1,w);
                  if(P34){ const seg2=[A,P34]; const s2=styleForGate(34,D,P,seg2); if(s2) drawStroke(seg2,s2,w); } }
  if(has(10,20) && P10){ const seg1=[P10,B]; const s1=styleForGate(10,D,P,seg1); if(s1) drawStroke(seg1,s1,w);
                          const seg2=spine(0.0, 1/3, 80); const s2=styleForGate(20,D,P,seg2); if(s2) drawStroke(seg2,s2,w); }
  if(has(57,34)){ const seg1=spine(1.0, 2/3, 80); const s1=styleForGate(57,D,P,seg1); if(s1) drawStroke(seg1,s1,w);
                  if(P34){ const seg2=[A,P34]; const s2=styleForGate(34,D,P,seg2); if(s2) drawStroke(seg2,s2,w); } }
  if(has(10,57) && P10){ const seg1=[P10,B]; const s1=styleForGate(10,D,P,seg1); if(s1) drawStroke(seg1,s1,w);
                          const seg2=spine(2/3, 1.0, 100); const s2=styleForGate(57,D,P,seg2); if(s2) drawStroke(seg2,s2,w); }
  if(has(20,57)){ const full=spine(0.0,1.0,200); const [left,right]=halfSegments(full);
                  const sL=styleForGate(20,D,P,left); if(sL) drawStroke(left,sL,w);
                  const sR=styleForGate(57,D,P,right); if(sR) drawStroke(right,sR,w); }

  // Seam mask near A/B (hide outline at joins)
  const mask=document.getElementById('maskSpineOutline'); while(mask.firstChild) mask.removeChild(mask.firstChild);
  const vb=(svg.getAttribute('viewBox')||'0 0 720 1080').split(/\s+/).map(parseFloat);
  el('rect',{x:vb[0],y:vb[1],width:vb[2],height:vb[3],fill:'white'}, mask);
  gCenters.querySelectorAll('.center-shape').forEach(s=>{
    const c=s.cloneNode(true); c.removeAttribute('class'); c.setAttribute('fill','black'); c.setAttribute('stroke','none'); mask.appendChild(c);
  });
  function disk(p,r){ const c=el('circle',{cx:p[0],cy:p[1],r,fill:'black',stroke:'none'}); mask.appendChild(c); }
  const outlineW=10; disk(AB.A,outlineW/2+1.5); disk(AB.B,outlineW/2+1.5);
}

function applyBodygraph(json){
  const {centersDefined,D,P} = parseApi(json);
  drawCenters(); drawGates();
  paintCenters(centersDefined);
  drawGatesStyled(D,P,centersDefined);
  gChannels.innerHTML='';
  paintNonIntegrationHalves(D,P);
  paintIntegration(D,P);
  return true;
}

/* ===== Activation columns ===== */
const PLANET_ORDER = ["sun","earth","north_node","south_node","moon","mercury","venus","mars","jupiter","saturn","uranus","neptune","pluto"];
const PLANET_SYMBOL = {
  sun:"\u2609", earth:"\u2295", moon:"\u263D",
  mercury:"\u263F", venus:"\u2640", mars:"\u2642",
  jupiter:"\u2643", saturn:"\u2644", uranus:"\u2645",
  neptune:"\u2646", pluto:"\u2647",
  north_node:"\u260A", south_node:"\u260B"
};
const KEY_ALIASES = { merucy:"mercury", nepture:"neptune", northnode:"north_node", southnode:"south_node" };
function sanitizeActivations(obj){
  const out={}; for(const [k,v] of Object.entries(obj||{})){
    const key = KEY_ALIASES[k] || k;
    out[key] = v;
  } return out;
}
function renderColumns(json){
  const dRaw = sanitizeActivations(json.activations?.design||{});
  const pRaw = sanitizeActivations(json.activations?.personality||{});
  const dUl = document.getElementById('list-design');
  const pUl = document.getElementById('list-personality');
  dUl.innerHTML=""; pUl.innerHTML="";
  PLANET_ORDER.forEach(pl=>{
    const dVal = dRaw[pl]; const pVal = pRaw[pl];
    if(dVal){
      const li=document.createElement('li');
      li.innerHTML = `<span class="pl"><span class="sym">${PLANET_SYMBOL[pl]||""}</span><span>${pl.replace('_',' ')}</span></span><span class="val">${dVal}</span>`;
      dUl.appendChild(li);
    }
    if(pVal){
      const li=document.createElement('li');
      li.innerHTML = `<span class="pl"><span class="sym">${PLANET_SYMBOL[pl]||""}</span><span>${pl.replace('_',' ')}</span></span><span class="val">${pVal}</span>`;
      pUl.appendChild(li);
    }
  });
}

/* ===== API + flow wiring ===== */
const HD_ENDPOINT = 'https://api.humandesignapi.nl/v1/bodygraphs';
async function fetchBodygraph(payload){
  // Try your proxy first (recommended; keeps keys server-side)
  try{
    const r = await fetch('/api/bodygraph', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(r.ok) return await r.json();
  }catch(_){}
  // Fallback direct (will work only if CORS and no-key mode allowed)
  const r2 = await fetch(HD_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  if(!r2.ok) throw new Error(`API ${r2.status}`);
  return r2.json();
}

function showScreen(idToShow){
  document.getElementById('screen-intro').classList.toggle('hidden', idToShow!=='intro');
  document.getElementById('screen-chart').classList.toggle('hidden', idToShow!=='chart');
}

async function handleGenerate(useSample=false){
  const name = document.getElementById('inpName').value.trim();
  const status = document.getElementById('status');
  let json;
  try{
    status.textContent = useSample ? "Loading sampleâ€¦" : "Fetchingâ€¦";
    if(useSample){
      json = window.__HD_EXAMPLE_JSON__;
    }else{
      const birthdate = toHdBirthdate(selDay.value, selMonth.value, selYear.value);
      const birthtime = to24hTime(selHour.value, selMinute.value, selAmPm.value);
      const location = document.getElementById('inpLoc').value.trim();
      json = await fetchBodygraph({ birthdate, birthtime, location });
    }
    status.textContent = "Renderingâ€¦";
    showScreen('chart');
    document.getElementById('namebar').textContent = name || "";
    document.getElementById('utcbar').textContent = json.birth_date_UTC ? (new Date(json.birth_date_UTC)).toUTCString() : "";
    applyBodygraph(json);
    renderColumns(json);
    // Persist for details page
    sessionStorage.setItem('hd_json', JSON.stringify(json));
    sessionStorage.setItem('hd_name', name||"");
    sessionStorage.setItem('hd_utc', json.birth_date_UTC || "");
    status.textContent = "";
  }catch(e){
    console.error(e);
    status.textContent = "Sorryâ€”couldn't fetch chart. Try sample?";
  }
}

/* Buttons */
document.getElementById('btnGo').addEventListener('click', ()=>handleGenerate(false));
document.getElementById('btnSample').addEventListener('click', ()=>handleGenerate(true));
document.getElementById('btnDetails').addEventListener('click', ()=>{
  window.location.href = 'details.html';
});

/* Sample JSON */
window.__HD_EXAMPLE_JSON__ = {
  "type":"Manifestor","profile":"6/2",
  "channels_short":["25-51","7-31","20-34"],
  "centers":["Ego","G","Throat"],
  "strategy":"Inform","authority":"Ego Projected",
  "definition":"Single Definition","signature":"Peace","not_self_theme":"Anger",
  "activations":{
    "design": { "sun":"25.2","earth":"46.2","north_node":"61.6","south_node":"62.6","moon":"20.3","mercury":"51.2","venus":"27.1","mars":"12.1","jupiter":"31.2","saturn":"41.3","uranus":"38.5","neptune":"54.2","pluto":"43.2" },
    "personality": { "sun":"12.6","earth":"11.6","north_node":"54.5","south_node":"53.5","moon":"46.6","mercury":"15.3","venus":"33.6","mars":"7.2","jupiter":"33.5","saturn":"41.5","uranus":"38.4","neptune":"54.1","pluto":"1.6" }
  },
  "birth_date_UTC":"1991-06-19T14:32:00.000Z"
};

/* Initial draw (blank template baseline) */
drawCenters(); drawGates(); paintChannelBaseOutlined();

</script>
</body>
</html>
