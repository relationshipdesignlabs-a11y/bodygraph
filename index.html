<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Discover your design</title>
  <style>
    :root{ --cyan:#00bcd4; --ink:#0a0f12; --muted:#64748b; }
    *{ box-sizing:border-box }
    html,body{ margin:0; height:100% }
    body{ background:#fff; color:var(--ink); font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap{ max-width:1200px; margin:0 auto; padding:24px; }
    .card{ background:#f7fbff; border:1px solid #cdeef5; border-radius:14px; padding:16px; box-shadow:0 8px 36px rgba(0,0,0,.06) }
    h1{ margin:0 0 12px; font-size:22px }
    label{ font-size:12px; color:var(--ink); font-weight:600 }
    .row{ display:flex; gap:10px; align-items:end; margin:10px 0 }
    select, input[type="text"]{
      padding:10px 12px; border:1px solid #d1e7ef; border-radius:10px; font-size:14px; outline:none
    }
    button.primary{ background:var(--cyan); color:#fff; border:0; border-radius:12px; padding:10px 14px; cursor:pointer }

    #view-intake{ display:block }
    #view-chart{ display:none }
    .layout{ display:grid; grid-template-columns:260px 1fr 260px; gap:16px; align-items:start; }

    #chartFrameWrap{ background:#fff; border:1px solid #e6eef2; border-radius:12px; padding:8px; }
    #chartTitle{ text-align:center; font-size:15px; font-weight:800; letter-spacing:.08em; margin:6px 0 0; }
    #chartSubtitle{ text-align:center; font-size:13px; color:var(--muted); margin:0 0 8px; }
    #chartFrame{ width:100%; height:900px; border:0; display:block; }

    .col{ background:#fff; border:1px solid #e6eef2; border-radius:12px; padding:12px }
    .colTitle{ font-size:15px; font-weight:800; letter-spacing:.08em; margin:4px 0 10px }
    .colTitle.design{ color:var(--cyan) }
    .colTitle.person{ color:#111 }
    .actItem{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:10px; background:#fff }
    .actLeft{ display:flex; align-items:center; gap:10px }
    .actPlanet{ width:22px; text-align:center; font-size:18px; opacity:.9 }
    .actVal{ font-size:18px; font-weight:600 }
    #view-intake.card{ max-width:480px }
    .ac-wrap{ position:relative }
    .ac-list{ position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #e6eef2; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.08); z-index:20; overflow:hidden }
    .ac-item{ padding:8px 10px; cursor:pointer; font-size:14px }
    .ac-item:hover{ background:#f3f8fb }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="view-intake" class="card">
      <h1>Discover your design</h1>
      <div class="row">
        <div style="display:grid; grid-template-columns:auto 1fr; gap:8px; align-items:center;">
          <label>Name</label>
          <input id="hdName" type="text" placeholder="your name" style="width:260px">
        </div>
      </div>
      <div class="row" style="display:grid; grid-template-columns:auto 1fr 1fr 1fr; gap:8px; align-items:end;">
        <label>Birth Date</label>
        <select id="monthSel"></select>
        <select id="daySel"></select>
        <select id="yearSel"></select>
      </div>
      <div class="row">
        <div style="display:grid; grid-template-columns:auto 1fr; gap:8px; align-items:center;">
          <label>Birth Time (12h)</label>
          <div style="display:flex; gap:6px; align-items:center;">
            <select id="hh12"></select> : <select id="mm12"></select>
            <select id="ampm12"><option>AM</option><option>PM</option></select>
          </div>
        </div>
      </div>
      <div class="row">
        <div style="display:grid; grid-template-columns:auto 1fr; gap:8px; align-items:center;">
          <label>Location</label>
          <div class="ac-wrap" style="width:260px">
            <input id="hdLoc" type="text" placeholder="City, country" style="width:100%">
            <div id="acList" class="ac-list" style="display:none"></div>
          </div>
        </div>
      </div>
      <div class="row">
        <button id="generateBtn" class="primary">Generate chart</button>
        <span id="renderStatus" style="color:var(--muted)"></span>
      </div>
    </div>

    <div id="view-chart" class="layout">
      <div id="designCol" class="col"><div class="colTitle design">DESIGN</div></div>
      <div>
        <div id="chartFrameWrap">
          <div id="chartTitle" style="text-align:center; font-size:16px; font-weight:800; letter-spacing:.08em; margin:4px 0 0;"></div>
          <div id="chartSubtitle" style="text-align:center; font-size:13px; color:#64748b; margin:0 0 8px;"></div>
          <iframe id="chartFrame" src="/WORKING.html?v=ab2" loading="eager"></iframe>
        </div>
      </div>
      <div id="personCol" class="col"><div class="colTitle person">PERSONALITY</div></div>
    </div>
  </div>

  <script>
    const PLANET_SYM = { sun:"☉", earth:"♁", moon:"☾", mercury:"☿", venus:"♀", mars:"♂", jupiter:"♃", saturn:"♄", uranus:"♅", neptune:"♆", pluto:"♇", north_node:"☊", south_node:"☋", merucy:"☿", nepture:"♆" };
    const pad = n => String(n).padStart(2,'0');
    const formatUtc = (iso)=>{ try{ const d=new Date(iso); if(!isFinite(d)) return ''; return `${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())} ${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())} UTC`; }catch(e){ return ''; } };

    function initDOB(){
      const m = document.getElementById('monthSel');
      const d = document.getElementById('daySel');
      const y = document.getElementById('yearSel');
      if(m && m.options.length===0){
        const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
        months.forEach((name,idx)=>{ const o=document.createElement('option'); o.value=String(idx+1).padStart(2,'0'); o.textContent=name; m.appendChild(o); });
      }
      if(d && d.options.length===0){ for(let i=1;i<=31;i++){ const o=document.createElement('option'); o.value=String(i).padStart(2,'0'); o.textContent=String(i); d.appendChild(o); } }
      if(y && y.options.length===0){ const now=new Date().getFullYear(); for(let yr=now; yr>=1915; yr--){ const o=document.createElement('option'); o.value=String(yr); o.textContent=String(yr); y.appendChild(o); } }
      function daysInMonth(Y,M){ return new Date(Y, M, 0).getDate(); }
      function normalize(){ if(!(y&&m&&d)) return; const max=daysInMonth(parseInt(y.value||new Date().getFullYear(),10), parseInt(m.value||1,10));
        Array.from(d.options).forEach(opt=>{ opt.disabled = parseInt(opt.value,10) > max; });
        if(parseInt(d.value||'1',10) > max) d.value = String(max).padStart(2,'0');
      }
      if(m) m.addEventListener('change', normalize);
      if(y) y.addEventListener('change', normalize);
      normalize();

      const hhSel = document.getElementById('hh12');
      const mmSel = document.getElementById('mm12');
      const apSel = document.getElementById('ampm12');
      if(hhSel && hhSel.options.length===0){ for(let h=1; h<=12; h++){ const o=document.createElement('option'); o.value=String(h); o.textContent=String(h); if(h===12) o.selected=true; hhSel.appendChild(o); } }
      if(mmSel && mmSel.options.length===0){ for(let m=0; m<60; m++){ const o=document.createElement('option'); o.value=String(m).padStart(2,'0'); o.textContent=o.value; if(m===0) o.selected=true; mmSel.appendChild(o); } }
      if(apSel && !apSel.value){ apSel.value='AM'; }
    }

    let acToken = Math.random().toString(36).slice(2);
    let acSel = null;
    function initAutocomplete(){
      const locInput = document.getElementById('hdLoc');
      const acList = document.getElementById('acList');
      async function fetchPredictions(q){
        if(!q || q.length < 2){ acList.style.display='none'; acList.innerHTML=''; return; }
        try{
          const r = await fetch(`/api/places?q=${encodeURIComponent(q)}&session=${acToken}`);
          const js = await r.json();
          const items = Array.isArray(js.predictions) ? js.predictions : [];
          if(!items.length){ acList.style.display='none'; acList.innerHTML=''; return; }
          acList.innerHTML = items.map(p=>`<div class="ac-item" data-id="${p.place_id}">${p.description}</div>`).join('');
          acList.style.display='block';
        }catch(e){ console.warn(e); }
      }
      locInput.addEventListener('input', (e)=>{ acSel=null; fetchPredictions(e.target.value.trim()); });
      acList.addEventListener('click', async (e)=>{
        const item = e.target.closest('.ac-item'); if(!item) return;
        const pid = item.getAttribute('data-id'); const desc = item.textContent;
        locInput.value = desc; acList.style.display='none'; acSel = { place_id: pid, description: desc };
      });
      document.addEventListener('click', (e)=>{ if(!acList.contains(e.target) && e.target !== locInput){ acList.style.display='none'; } });
    }

    function sanitizeIframe(doc){
      const hide = ['.section','#leftPanel','#centerPanel','#gatePanel','#channelPanel','#workspace','#modeSection','#verticalGuideSection','#dataSection','#gGrid','#gGuide','#grid','#guide','#handles','#centerline','#gCenterline','#controls','#bgfile','#showGrid','#snap','#snapStep','#showGuide','#guideX','#magnet','#centerOnGuide','#save','#load','#loadSampleBtn'];
      hide.forEach(sel=> doc.querySelectorAll(sel).forEach(el=> el.style.display='none') );
      const svg = doc.querySelector('svg#svg'); if(svg){ svg.style.background='#fff'; svg.style.width='100%'; }
    }

    function renderActivations(json){
      const dCol = document.getElementById('designCol');
      const pCol = document.getElementById('personCol');
      dCol.innerHTML = '<div class="colTitle design">DESIGN</div>';
      pCol.innerHTML = '<div class="colTitle person">PERSONALITY</div>';
      const order=["sun","earth","north_node","south_node","moon","mercury","venus","mars","jupiter","saturn","uranus","neptune","pluto"];
      const build=(obj, side)=>{
        if(!obj) return '';
        const entries = Object.entries(obj).sort((a,b)=> order.indexOf(a[0].toLowerCase()) - order.indexOf(b[0].toLowerCase()));
        return entries.map(([k,v])=>{
          const key=k.toLowerCase(); const sym=PLANET_SYM[key]||PLANET_SYM[k]||"";
          const gl = (typeof v==='string') ? v : (v && (v.value||v.gate_line||v.gate)) || '';
          const color = side==='design' ? 'style="color:var(--cyan)"' : 'style="color:#0a0f12"';
          return `<div class="actItem" ${color}>
            <div class="actLeft"><div class="actPlanet">${sym}</div><div style="opacity:.85;text-transform:capitalize">${key.replace('_',' ')}</div></div>
            <div class="actVal">${gl}</div>
          </div>`;
        }).join('');
      };
      dCol.innerHTML += build(json?.activations?.design, 'design');
      pCol.innerHTML += build(json?.activations?.personality, 'personality');
    }

    async function generateChart(){
      const m = document.getElementById('monthSel').value;
      const d = document.getElementById('daySel').value;
      const y = document.getElementById('yearSel').value;
      const hh = parseInt(document.getElementById('hh12').value||'12',10);
      const mm = document.getElementById('mm12').value||'00';
      const ampm = (document.getElementById('ampm12').value||'AM');
      let HH = hh; if(ampm==='PM' && HH!==12) HH+=12; if(ampm==='AM' && HH===12) HH=0;
      const t = String(HH).padStart(2,'0') + ':' + mm;
      let loc = (document.getElementById('hdLoc').value || '').trim();
      const name = (document.getElementById('hdName').value || '').trim();
      const status = document.getElementById('renderStatus');
      const monthName = n => ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][parseInt(n,10)-1];
      const birthdate = `${d}-${monthName(m)}-${String(y).slice(-2)}`;

      try{
        status.textContent = 'Generating…';
        if(acSel && acSel.place_id){
          try{
            const rr = await fetch(`/api/place-details?place_id=${encodeURIComponent(acSel.place_id)}&session=${acToken}`);
            const dj = await rr.json(); if(dj && dj.formatted_address){ loc = dj.formatted_address; }
          }catch(e){}
        }

        const r = await fetch('/api/bodygraph', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ birthdate, birthtime: t, location: loc }) });
        const json = await r.json();
        try{ sessionStorage.setItem('hd_last_chart', JSON.stringify(json)); sessionStorage.setItem('hd_name', name); }catch(e){}

        document.getElementById('view-intake').style.display='none';
        document.getElementById('view-chart').style.display='grid';

        document.getElementById('chartTitle').textContent = name || '';
        document.getElementById('chartSubtitle').textContent = (json && json.birth_date_UTC) ? formatUtc(json.birth_date_UTC) : '';

        renderActivations(json);

        const frame = document.getElementById('chartFrame');
        const onLoad = () => {
          const doc = frame.contentDocument || frame.contentWindow.document;
          sanitizeIframe(doc);
          let tries=0;
          const tick = setInterval(()=>{
            try{
              if(frame.contentWindow && typeof frame.contentWindow.applyBodygraph==='function'){
                frame.contentWindow.applyBodygraph(json);
                const svg = doc.querySelector('svg#svg');
                const target = doc.querySelector('#gBody') || svg;
                if(target && target.getBBox){
                  const bbox = target.getBBox();
                  const h = Math.ceil(bbox.y + bbox.height) + 20;
                  frame.style.height = Math.max(720, h) + 'px';
                }
                clearInterval(tick);
              }
            }catch(e){}
            if(++tries>50) clearInterval(tick);
          }, 100);
          frame.removeEventListener('load', onLoad);
        };
        if (frame.contentDocument && frame.contentDocument.readyState === 'complete') onLoad();
        else frame.addEventListener('load', onLoad);

      }catch(e){
        console.error(e);
        status.textContent = 'Could not render — please check inputs.';
        setTimeout(()=> status.textContent = '', 4000);
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      initDOB(); initAutocomplete();
      document.getElementById('generateBtn').addEventListener('click', generateChart);
    });
  </script>
</body>
</html>
