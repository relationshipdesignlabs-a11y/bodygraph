<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bodygraph Renderer</title>
<style>
  html,body{margin:0;height:100%;background:#fff}
  .wrap{display:flex;align-items:center;justify-content:center;min-height:100%;background:#fff}
  #view{width:100%;max-width:720px;aspect-ratio: 2/3;border:0;display:block;background:#fff;border-radius:8px;overflow:hidden}
  #engine{position:fixed;left:-9999px;top:-9999px;width:800px;height:1200px;border:0}
  #note{position:fixed;bottom:8px;left:8px;font:12px/1.3 system-ui;color:#444;background:#fff8;border:1px solid #ddd;padding:6px 8px;border-radius:8px}
</style>
</head>
<body>
<div class="wrap">
  <iframe id="view"></iframe>
  <iframe id="engine" loading="eager"></iframe>
</div>
<div id="note" hidden>Loading bodygraph engine…</div>
<script>
const engine = document.getElementById('engine');
const view   = document.getElementById('view');
const note   = document.getElementById('note');

// Try multiple possible filenames so deployments that are missing one still work
const engineCandidates = ['WORKING-5.html','WORKING-4.html','WORKING-3.html','WORKING-2.html','WORKING.html'];

let pickedSrc = null;
let tryIndex  = 0;

function pickNextEngine(){
  if(tryIndex >= engineCandidates.length){
    note.hidden = false;
    note.textContent = 'Could not find a working renderer (WORKING-*.html).';
    return;
  }
  pickedSrc = engineCandidates[tryIndex++];
  note.hidden = false;
  note.textContent = 'Loading ' + pickedSrc + ' …';
  engine.src = pickedSrc + '?v=' + Date.now(); // cache-bust
}

function injectNoGateBorderCSS(doc){
  try{
    const style = doc.createElement('style');
    style.textContent = '.gate-dot,.gate circle{stroke:none!important}.gate-defined{stroke:none!important}';
    doc.head.appendChild(style);
  }catch(_){}
}

function mirrorSVG(){
  try{
    const ed = engine.contentDocument;
    const vd = view.contentDocument;
    if(!ed || !vd) return false;
    const svg = ed.querySelector('svg#svg') || ed.querySelector('svg');
    if(!svg) return false;
    const html = '<!doctype html><html><head><meta charset=\"utf-8\"><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"><style>html,body{margin:0;height:100%;background:#fff}</style></head><body>' + svg.outerHTML + '</body></html>';
    vd.open(); vd.write(html); vd.close();
    note.hidden = true;
    return true;
  }catch(_){ return false; }
}

// Forwarded API for parent pages
window.applyBodygraph = function(json){
  try{
    if(engine.contentWindow && typeof engine.contentWindow.applyBodygraph === 'function'){
      engine.contentWindow.applyBodygraph(json);
      setTimeout(mirrorSVG, 60);
    }
  }catch(_){}
};

let loadTimer = null;
engine.addEventListener('load', () => {
  try{
    injectNoGateBorderCSS(engine.contentDocument);
    // Give the engine a moment to draw
    setTimeout(() => {
      if(!mirrorSVG()){
        // If we couldn't find an SVG, try the next candidate
        pickNextEngine();
      }else{
        // Keep in sync on mutations
        try{
          const obs = new MutationObserver(() => mirrorSVG());
          const root = engine.contentDocument.querySelector('svg#svg')?.parentNode || engine.contentDocument.body;
          obs.observe(root, {subtree:true,childList:true,attributes:true,characterData:true});
        }catch(_){}
      }
    }, 100);
  }catch(_){
    pickNextEngine();
  }
});
engine.addEventListener('error', pickNextEngine);

// Kick off
pickNextEngine();
</script>
</body>
</html>
