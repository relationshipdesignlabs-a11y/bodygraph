<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bodygraph — Production View</title>
<style>
  :root{
    --bg:#ffffff; --ink:#0a0f12; --muted:#7e8b91;
    --cyan:#00d5ff;           /* Design color (centers + design channels) */
    --person:#111111;         /* Personality color (channels + gate dots) */
    --undef:#ffffff;          /* Undefined center/channel background */
    --edge:#0a0f12;           /* Center perimeter */
  }
  html,body{margin:0;height:100%;background:#fff;color:#111;font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  /* Layout: single full-width panel with the SVG canvas */
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .frame{background:#fff;border-radius:14px}
  .canvas{display:flex;justify-content:center;align-items:center}
  svg{width:100%;max-width:none;height:auto;background:#fff;user-select:none;touch-action:none}

  /* Centers */
  .center-shape{fill:var(--undef);stroke:var(--edge);stroke-width:2}
  .defined-center{fill:var(--cyan)!important;stroke:var(--edge)!important}
  .undefined-center{fill:var(--undef)!important;stroke:var(--edge)!important}

  /* Gates */
  .gate circle{fill:var(--undef);stroke:none}
  .gate text{fill:#111;font-size:10px;font-weight:600}
  .gate-defined{fill:var(--person)!important;stroke:var(--person)!important}
  .gate-text-invert{fill:#fff!important}
  .gate-dot{stroke:#111;stroke-width:1.2}

  /* Channels baseline: white interior with black outline, clipped at centers */
  .base-outline{fill:none;stroke:#000;pointer-events:none}
  .base-fill{fill:none;stroke:var(--undef);pointer-events:none}

  /* Half-channel painter */
  .halfstroke{fill:none;stroke-linecap:round;opacity:1}

  /* Mirrored candy stripes (black/cyan 50/50) — rotated per channel direction */
  .candy rect{shape-rendering:crispEdges}

  /* Hide any leftover editor UI if present */
  #gGrid,#grid,#gGuide,#guide,#handles,#centerline,#gCenterline,#controls,#workspace,#bgfile,
  #showGrid,#snap,#snapStep,#showGuide,#guideX,#magnet,#centerOnGuide,#save,#load,#loadSampleBtn { display:none!important; }

  /* Center perimeter on top for crisp edge + tiny "openings" at active gates */
  .center-edge-top{fill:none;stroke:var(--edge);pointer-events:none}
  .center-open{pointer-events:none}

  /* A/B invisible handles/labels (logic keeps using A/B points under the hood) */
  #ablayer, #ablayer .abHandle, #ablayer .abLabel { display:none!important; opacity:0!important; pointer-events:none!important; }
</style>
</head>

<body>
  <div class="wrap">
    <div class="frame">
      <div class="canvas">
        <!-- ===== Bodygraph SVG ===== -->
        <svg id="svg" viewBox="0 0 720 1080" preserveAspectRatio="xMidYMid meet">
          <defs>
            <!-- mask used to clip channels so they don't draw inside centers -->
            <mask id="clipCenters" maskUnits="userSpaceOnUse" maskContentUnits="userSpaceOnUse"></mask>

            <!-- mask to remove spine outline right at A/B so there’s no seam -->
            <mask id="maskSpineOutline" maskUnits="userSpaceOnUse" maskContentUnits="userSpaceOnUse"></mask>

            <!-- base candy template (equal black/cyan 6px/6px) -->
            <pattern id="candyTemplate" patternUnits="userSpaceOnUse" width="12" height="12" class="candy">
              <rect width="6" height="12" fill="#111"/>
              <rect x="6" width="6" height="12" fill="#00d5ff"/>
            </pattern>

            <!-- soft highlight (kept from earlier builds) -->
            <filter id="hl" x="-20%" y="-20%" width="140%" height="140%">
              <feDropShadow dx="0" dy="0" stdDeviation="4" flood-color="#8ad" flood-opacity=".6"/>
            </filter>
          </defs>

          <!-- Layers -->
          <g id="centers"></g>     <!-- centers -->
          <g id="channels"></g>    <!-- channels -->
          <g id="gates"></g>       <!-- gates -->
        </svg>
      </div>
    </div>
  </div>

  <!-- ============== JS: Core draw + API integration ============== -->
  <script>
  /********************
   * BASIC GEOMETRY    (Your current mapping; unchanged from your working build)
   ********************/
  const NS="http://www.w3.org/2000/svg";
  const svg = document.getElementById('svg');
  const gCenters = document.getElementById('centers');
  const gChannels = document.getElementById('channels');
  const gGates = document.getElementById('gates');

  /* === YOUR MAPPING (centers/gates/channels) ===
     This is the same data you’ve been using. I’m embedding what you last shared
     so this file is truly self-contained. If you update coordinates later,
     you can paste the new USER_MAP object here. */
  const USER_MAP = {
    centers: [{"id":"Head","type":"tri","x":295,"y":72.3100738525,"w":130,"h":110,"rot":0,"dir":"up"},
              {"id":"Ajna","type":"tri","x":295,"y":200,"w":130,"h":110,"rot":0,"dir":"down"},
              {"id":"Throat","type":"rect","x":300,"y":325.3846130371,"w":120,"h":120,"rot":0,"rx":18},
              {"id":"G","type":"diamond","x":295,"y":485.552734375,"w":130,"h":130,"rot":45},
              {"id":"Ego","type":"tri","x":450.1537780762,"y":596.6154174805,"w":90,"h":80,"rot":152,"dir":"right"},
              {"id":"Spleen","type":"tri","x":81.3846054077,"y":661.6923217773,"w":120,"h":130,"rot":180,"dir":"left"},
              {"id":"Solar","type":"tri","x":524.7692260742,"y":659.076965332,"w":120,"h":130,"rot":180,"dir":"right"},
              {"id":"Sacral","type":"rect","x":300,"y":690.4544067383,"w":120,"h":120,"rot":0,"rx":18},
              {"id":"Root","type":"rect","x":300,"y":834.3428955078,"w":120,"h":120,"rot":0,"rx":18}],
    gates: {"1":[360,481.2339477539],"2":[360,621.90234375],"3":[360,796.8123168945],"4":[399.6923217773,215.0769195557],
            "5":[324.8329162598,705.1928100586],"6":[552.9230957031,723.6923217773],"7":[323.9074401855,513.6246948242],
            "8":[360,432.1850891113],"9":[392.3907470703,795.8869018555],"10":[289.665802002,550.6427001953],
            "11":[385.9125976562,239.6915130615],"12":[407.1979370117,378.5090026855],"13":[397.9434509277,515.4755859375],
            "14":[360,705.1928100586],"15":[324.8329162598,588.5861206055],"16":[313.7275085449,354.4472961426],
            "17":[334.0874023438,240.616973877],"18":[94.1538467407,768.9230957031],"19":[407.1979370117,876.4010009766],
            "20":[312.8020629883,382.2107849121],"21":[514.1538696289,605.5384521484],"22":[605.5384521484,696],
            "23":[360,338.7146606445],"24":[360,215.0769195557],"25":[430.334197998,548.7917480469],
            "26":[480.9230651855,643.3846435547],"27":[313.7275085449,772.7506713867],"28":[120.9230804443,756],
            "29":[396.0925598145,705.1928100586],"30":[631.3846435547,767.0769042969],"31":[323.9074401855,432.1850891113],
            "32":[146.7692260742,742.1538696289],"33":[397.8461608887,431.0769348145],"34":[313.7275085449,732.9562988281],
            "35":[408.1233825684,349.8200378418],"36":[632.3076782227,681.2307739258],"37":[579.6923217773,708],
            "38":[313.7275085449,905.0899658203],"39":[407.1979370117,906.0154418945],"40":[532.6153564453,639.6923217773],
            "41":[407.1979370117,936.5552978516],"42":[328.5346984863,796.8123168945],"43":[360,283.1876525879],
            "44":[146.2210845947,711.6709594727],"45":[407.1979370117,406.2724914551],"46":[396.0925598145,586.7352294922],
            "47":[320.3076782227,214.1538391113],"48":[94.1538467407,684],"49":[576.9230957031,738.4615478516],
            "50":[173.0591278076,727.4036254883],"51":[497.5384521484,624.9230957031],"52":[392.3907470703,849.5629882812],
            "53":[328.5346984863,849.5629882812],"54":[313.7275085449,873.6246948242],"55":[603.6923217773,752.3076782227],
            "56":[385.9125976562,337.7892150879],"57":[119.0769195557,697.8461303711],"58":[313.7275085449,937.4807128906],
            "59":[407.1979370117,771.8251953125],"60":[360,849.5629882812],"61":[360,167.0769195557],
            "62":[334.0874023438,338.7146606445],"63":[399.6923217773,167.0769195557],"64":[320.3076782227,167.0769195557]},
    gateRadius: {}, /* default 12 applied below */
    channels: {
      "1-8":{"a":"1","b":"8","style":"orth","w":8,"ctrl":[380,482.5]},
      "14-2":{"a":"2","b":"14","style":"orth","w":8,"ctrl":[390,710]},
      "3-60":{"a":"3","b":"60","style":"orth","w":8,"ctrl":[210,525]},
      "4-63":{"a":"4","b":"63","style":"orth","w":8,"ctrl":[400,205]},
      "15-5":{"a":"5","b":"15","style":"orth","w":8,"ctrl":[370,657.5]},
      "6-59":{"a":"6","b":"59","style":"curve","w":8,"ctrl":[489.23,744.92]},
      "31-7":{"a":"7","b":"31","style":"orth","w":8,"ctrl":[360,505]},
      "52-9":{"a":"9","b":"52","style":"orth","w":8,"ctrl":[340,862.5]},
      "10-20":{"a":"10","b":"20","style":"curve","w":8,"ctrl":[182.76,524.30]},
      "10-34":{"a":"10","b":"34","style":"curve","w":8,"ctrl":[77.53,531.69]},
      "10-57":{"a":"10","b":"57","style":"curve","w":8,"ctrl":[187.38,507.69]},
      "11-56":{"a":"11","b":"56","style":"orth","w":8,"ctrl":[390,332.5]},
      "12-22":{"a":"12","b":"22","style":"curve","w":8,"ctrl":[535.52,531.81]},
      "13-33":{"a":"13","b":"33","style":"orth","w":8,"ctrl":[340,470]},
      "16-48":{"a":"16","b":"48","style":"curve","w":8,"ctrl":[175.38,496.61]},
      "17-62":{"a":"17","b":"62","style":"orth","w":8,"ctrl":[315,320]},
      "18-58":{"a":"18","b":"58","style":"curve","w":8,"ctrl":[183.69,887.07]},
      "19-49":{"a":"19","b":"49","style":"curve","w":8,"ctrl":[518.86,827.03]},
      "20-34":{"a":"20","b":"34","style":"curve","w":8,"ctrl":[136.04,558.97]},
      "20-57":{"a":"20","b":"57","style":"curve","w":8,"ctrl":[175.38,546.46]},
      "21-45":{"a":"21","b":"45","style":"curve","w":8,"ctrl":[487.40,528.11]},
      "23-43":{"a":"23","b":"43","style":"orth","w":8,"ctrl":[345,332.5]},
      "24-61":{"a":"24","b":"61","style":"orth","w":8,"ctrl":[360,220]},
      "25-51":{"a":"25","b":"51","style":"curve","w":9,"ctrl":[462.46,576.92]},
      "26-44":{"a":"26","b":"44","style":"curve","w":8,"ctrl":[259.38,654.46]},
      "27-50":{"a":"27","b":"50","style":"curve","w":8,"ctrl":[270,757.5]},
      "28-38":{"a":"28","b":"38","style":"curve","w":8,"ctrl":[198.46,854.76]},
      "29-46":{"a":"29","b":"46","style":"orth","w":8,"ctrl":[380,690]},
      "32-54":{"a":"32","b":"54","style":"curve","w":8,"ctrl":[215.07,834.46]},
      "34-57":{"a":"34","b":"57","style":"curve","w":8,"ctrl":[156.92,568.61]},
      "35-36":{"a":"35","b":"36","style":"curve","w":8,"ctrl":[536.45,480.91]},
      "37-40":{"a":"37","b":"40","style":"curve","w":8,"ctrl":[563.29,667.85]},
      "39-55":{"a":"39","b":"55","style":"curve","w":8,"ctrl":[535.52,850.17]},
      "41-30":{"a":"41","b":"30","style":"curve","w":8,"ctrl":[561.23,870.46]},
      "42-53":{"a":"42","b":"53","style":"orth","w":8,"ctrl":[380,887.5]},
      "47-64":{"a":"47","b":"64","style":"orth","w":8,"ctrl":[320,205]}
    }
  };

  /* convenience */
  const CYAN  = getComputedStyle(document.documentElement).getPropertyValue('--cyan').trim() || '#00d5ff';
  const BLACK = getComputedStyle(document.documentElement).getPropertyValue('--person').trim() || '#111';

  /* utility */
  const key = (a,b)=>[String(a),String(b)].sort((x,y)=>+x-+y).join('-');

  /* draw helpers */
  function el(n, attrs={}, parent){ const e=document.createElementNS(NS,n); for(const k in attrs) e.setAttribute(k,attrs[k]); if(parent) parent.appendChild(e); return e; }

  /*********** centers ***********/
  function centerPath(c){
    const {type,x,y,w,h,rot=0,rx=18,dir='up'} = c;
    if(type==='rect') return el('rect',{x,y,width:w,height:h,rx,ry:rx,transform:`rotate(${rot} ${x+w/2} ${y+h/2})`});
    if(type==='diamond'){ const cx=x+w/2, cy=y+h/2; return el('rect',{x,y,width:w,height:h,rx:20,ry:20,transform:`rotate(${rot} ${cx} ${cy})`}); }
    if(type==='tri'){
      let pts; if(dir==='up') pts=`${x+w/2},${y} ${x+w},${y+h} ${x},${y+h}`;
      else if(dir==='down') pts=`${x},${y} ${x+w},${y} ${x+w/2},${y+h}`;
      else if(dir==='left') pts=`${x+w},${y} ${x+w},${y+h} ${x},${y+h/2}`;
      else pts=`${x},${y} ${x+w},${y+h/2} ${x},${y+h}`;
      return el('polygon',{points:pts,transform:`rotate(${rot} ${x+w/2} ${y+h/2})`});
    }
    return el('rect',{x,y,width:w,height:h,rx:10,ry:10});
  }
  function drawCenters(){
    gCenters.innerHTML='';
    USER_MAP.centers.forEach(c=>{
      const node=centerPath(c);
      node.classList.add('center-shape');
      node.dataset.id=c.id;
      gCenters.appendChild(node);
    });
  }

  /*********** gates ***********/
  const GATE_TO_CENTER={'64':'Head','61':'Head','63':'Head','47':'Ajna','24':'Ajna','4':'Ajna','62':'Throat','23':'Throat','56':'Throat','35':'Throat','12':'Throat','45':'Throat','33':'Throat','31':'Throat','8':'Throat','20':'Throat','16':'Throat','1':'G','2':'G','7':'G','13':'G','10':'G','15':'G','25':'G','46':'G','21':'Ego','51':'Ego','26':'Ego','40':'Ego','48':'Spleen','57':'Spleen','44':'Spleen','50':'Spleen','32':'Spleen','28':'Spleen','18':'Spleen','55':'Solar','36':'Solar','22':'Solar','37':'Solar','6':'Solar','49':'Solar','30':'Solar','34':'Sacral','5':'Sacral','14':'Sacral','29':'Sacral','59':'Sacral','27':'Sacral','9':'Sacral','3':'Sacral','42':'Sacral','58':'Root','38':'Root','54':'Root','53':'Root','60':'Root','52':'Root','19':'Root','39':'Root','41':'Root'};
  function drawGates(){
    gGates.innerHTML='';
    const ids=Object.keys(USER_MAP.gates).sort((a,b)=>+a-+b);
    ids.forEach(id=>{
      const [x,y]=USER_MAP.gates[id];
      const r=USER_MAP.gateRadius[id]||12;
      const g = el('g',{'class':'gate','data-id':id}, gGates);
      el('circle',{cx:x,cy:y,r,fill:'var(--undef)',stroke:'none'}, g);
      el('text',{x, y:y+4, 'text-anchor':'middle','font-size':'10','font-weight':'600', fill:'#111'}, g).textContent=id;
    });
  }

  /*********** channels ***********/
  function Q(A,C,B,t){ const u=1-t; return [u*u*A[0]+2*u*t*C[0]+t*t*B[0], u*u*A[1]+2*u*t*C[1]+t*t*B[1]]; }
  function sampleQuad(A,C,B,N=160){ const pts=[]; for(let i=0;i<=N;i++){ const t=i/N; pts.push(Q(A,C,B,t)); } return pts; }
  function sampleOrth(A,B){ const pts=[]; const midY=(A[1]+B[1])/2; const s=40;
    for(let i=0;i<=s;i++) pts.push([A[0], A[1] + (i/s)*(midY-A[1])]);
    for(let i=1;i<=s;i++) pts.push([A[0] + (i/s)*(B[0]-A[0]), midY]);
    for(let i=1;i<=s;i++) pts.push([B[0], midY + (i/s)*(B[1]-midY)]);
    return pts;
  }
  function pathD(pts){ if(!pts.length) return ''; let d=`M ${pts[0][0]},${pts[0][1]}`; for(let i=1;i<pts.length;i++) d+=` L ${pts[i][0]},${pts[i][1]}`; return d; }
  function pathAngle(pts){ const a=pts[0], b=pts[pts.length-1]; return Math.atan2(b[1]-a[1], b[0]-a[0])*180/Math.PI; }
  function midPoint(pts){ let sx=0,sy=0; for(const p of pts){ sx+=p[0]; sy+=p[1]; } return [sx/pts.length, sy/pts.length]; }
  function halfSegments(pts){ const L=[0]; for(let i=1;i<pts.length;i++){ const dx=pts[i][0]-pts[i-1][0], dy=pts[i][1]-pts[i-1][1]; L[i]=L[i-1]+Math.hypot(dx,dy); }
    const total=L[L.length-1], mid=total/2; let k=1; while(k<L.length && L[k]<mid) k++;
    const t=(mid-L[k-1])/Math.max(1e-6,(L[k]-L[k-1])); const mx=pts[k-1][0]+t*(pts[k][0]-pts[k-1][0]); const my=pts[k-1][1]+t*(pts[k][1]-pts[k-1][1]);
    const M=[mx,my]; const left=pts.slice(0,k); left.push(M); const right=[M, ...pts.slice(k)]; return [left,right];
  }
  let candyN=0;
  function svgMidX(){ const vb=(svg.getAttribute('viewBox')||'0 0 720 1080').split(/\s+/).map(parseFloat); return vb[0]+vb[2]/2; }
  function candyFor(pts){
    const deg=pathAngle(pts), m=midPoint(pts); let rot=deg+45; if(m[0]>svgMidX()) rot=180-rot;
    const defs=svg.querySelector('defs'); const tpl=document.getElementById('candyTemplate'); if(!defs||!tpl) return 'url(#candyTemplate)';
    const id=`candy-${++candyN}`; const pat=tpl.cloneNode(true); pat.id=id; pat.setAttribute('patternTransform',`rotate(${rot})`); defs.appendChild(pat); return `url(#${id})`;
  }
  function drawStroke(pts, style, width){
    if(!pts || pts.length<2) return;
    const p=el('path',{'class':'halfstroke','stroke-width':String(width||8),'d':pathD(pts),'stroke-linecap':'round','mask':'url(#clipCenters)'}, gChannels);
    if(style && style.type==='pattern') p.setAttribute('stroke', style.value);
    else p.setAttribute('stroke', style || '#000');
  }

  /* paint baseline outline + white interior for ALL channels (clipped at centers) */
  function ensureChannelMask(){
    const mask=document.getElementById('clipCenters'); while(mask.firstChild) mask.removeChild(mask.firstChild);
    const vb=(svg.getAttribute('viewBox')||'0 0 720 1080').split(/\s+/).map(parseFloat);
    const rect=el('rect',{x:vb[0],y:vb[1],width:vb[2],height:vb[3],fill:'white'}, mask);
    // add each center fill as black to punch holes
    gCenters.querySelectorAll('.center-shape').forEach(s=>{
      const c=s.cloneNode(true); c.removeAttribute('class'); c.setAttribute('fill','black'); c.setAttribute('stroke','none'); mask.appendChild(c);
    });
  }
  function paintChannelBaseOutlined(){
    ensureChannelMask();
    // clear old base layers
    gChannels.querySelectorAll('.base-outline,.base-fill').forEach(n=>n.remove());
    // clone any existing paths (if any) -> in our build we always redraw below, but keep this consistent
    Object.entries(USER_MAP.channels).forEach(([id,ch])=>{
      const A=USER_MAP.gates[ch.a], B=USER_MAP.gates[ch.b]; if(!A||!B) return;
      const d = (ch.style==='curve') ? pathD(sampleQuad(A, ch.ctrl || [(A[0]+B[0])/2,(A[1]+B[1])/2], B, 64))
                                     : pathD(sampleOrth(A,B));
      const w=ch.w||8;
      const outline=el('path',{'data-id':id,'class':'base-outline','stroke-width':String(w+2),'d':d,'mask':'url(#clipCenters)'}, gChannels);
      const fill=el('path',{'data-id':id,'class':'base-fill','stroke-width':String(w),'d':d,'mask':'url(#clipCenters)'}, gChannels);
    });
  }

  /*********** API parse + styling ***********/
  const CENTER_NAME_MAP = {"Head":"Head","Ajna":"Ajna","Throat":"Throat","G":"G","Ego":"Ego","Heart":"Ego","Spleen":"Spleen","Solar Plexus":"Solar","Solar Plexus Center":"Solar","Sacral":"Sacral","Root":"Root"};
  function gnum(v){ return String(v).split('.')[0]; }
  function parseApi(json){
    const centersDefined = new Set((json.centers||[]).map(n=>CENTER_NAME_MAP[n]||n));
    const D=new Set(), P=new Set();
    const d=json.activations?.design||{}, p=json.activations?.personality||{};
    Object.values(d).forEach(v=>{ if(v) D.add(gnum(v)); });
    Object.values(p).forEach(v=>{ if(v) P.add(gnum(v)); });
    const channels=new Set(); (json.channels_short||[]).forEach(s=>{ const [a,b]=String(s).split('-'); if(a&&b) channels.add(key(a,b)); });
    return {centersDefined,D,P,channels};
  }

  function paintCenters(centersDefined){
    drawCenters();
    gCenters.querySelectorAll('.center-shape').forEach(node=>{
      const id=node.dataset.id;
      if(centersDefined.has(id)){ node.classList.add('defined-center'); node.classList.remove('undefined-center'); }
      else{ node.classList.add('undefined-center'); node.classList.remove('defined-center'); }
    });

    // edge overlay + openers at active gates (after gates are drawn)
    setTimeout(()=>edgeOverlayAndOpeners(),0);
  }

  function edgeOverlayAndOpeners(){
    const oldTop=document.getElementById('gCenterEdgeTop'); if(oldTop) oldTop.remove();
    const oldOpen=document.getElementById('gCenterOpeners'); if(oldOpen) oldOpen.remove();

    const edge=el('g',{id:'gCenterEdgeTop'}, gCenters);
    gCenters.querySelectorAll('.center-shape').forEach(s=>{
      const c=s.cloneNode(true); c.setAttribute('class','center-edge-top'); c.setAttribute('fill','none');
      const sw=s.getAttribute('stroke-width')||'2'; c.setAttribute('stroke-width',sw); edge.appendChild(c);
    });

    const openers=el('g',{id:'gCenterOpeners'}, gCenters);
    gGates.querySelectorAll('.gate').forEach(elm=>{
      const id=elm.getAttribute('data-id'); // gate id
      const circle=elm.querySelector('circle'); const t=elm.querySelector('text'); if(!circle||!t) return;
      const centerId=GATE_TO_CENTER[id]; if(!centerId) return;
      const isActive = circle.classList.contains('gate-defined');
      if(!isActive) return;
      const cx=parseFloat(circle.getAttribute('cx')); const cy=parseFloat(circle.getAttribute('cy')); const r=parseFloat(circle.getAttribute('r'))||12;
      let sw=2; const refCenter=gCenters.querySelector(`.center-shape[data-id="${centerId}"]`); if(refCenter) sw=parseFloat(refCenter.getAttribute('stroke-width')||'2');
      const ropen = r + Math.max(2, sw*0.75);
      const color = getComputedStyle(document.documentElement).getPropertyValue('--undef').trim() || '#fff';
      const opener=el('circle',{cx,cy,r:ropen,fill:color,stroke:'none','class':'center-open'}, openers);
    });
  }

  function drawGatesStyled(D,P,centersDefined){
    drawGates();
    gGates.querySelectorAll('.gate').forEach(g=>{
      const id=g.getAttribute('data-id');
      const circles=g.querySelectorAll('circle'); const text=g.querySelector('text'); if(!circles.length) return;
      const centerId=GATE_TO_CENTER[id]||null; const centerDefined=centerId ? centersDefined.has(centerId) : false;
      const isDefined = D.has(id) || P.has(id);
      const c=circles[0]; for(let i=1;i<circles.length;i++){ circles[i].setAttribute('opacity','0'); circles[i].setAttribute('stroke','none'); }
      c.setAttribute('opacity','1');

      if(!centerDefined){
        if(isDefined){ c.classList.add('gate-defined'); c.setAttribute('fill',BLACK); c.setAttribute('stroke',BLACK); text.classList.add('gate-text-invert'); }
        else{ c.setAttribute('fill','var(--undef)'); c.setAttribute('stroke','none'); text.setAttribute('fill','#111'); }
        return;
      }
      // center defined
      if(isDefined){ c.classList.add('gate-defined'); c.setAttribute('fill',BLACK); c.setAttribute('stroke',BLACK); text.classList.add('gate-text-invert'); }
      else{ c.setAttribute('fill','var(--undef)'); c.setAttribute('stroke','none'); text.setAttribute('fill','#111'); }
    });
  }

  function styleForGate(g,D,P,pts){
    const d=D.has(String(g)), p=P.has(String(g));
    if(d && p) return {type:'pattern', value: candyFor(pts)};
    if(d) return CYAN;
    if(p) return BLACK;
    return null;
  }

  function paintNonIntegrationHalves(D,P){
    // baseline
    paintChannelBaseOutlined();
    const integ=new Set(['10-20','20-10','10-34','34-10','10-57','57-10','34-57','57-34','20-34','34-20','20-57','57-20']);
    Object.entries(USER_MAP.channels).forEach(([id,ch])=>{
      if(integ.has(id)) return;
      const A=USER_MAP.gates[ch.a], B=USER_MAP.gates[ch.b]; if(!A||!B) return;
      const pts = (ch.style==='curve') ? sampleQuad(A, ch.ctrl || [(A[0]+B[0])/2,(A[1]+B[1])/2], B, 120)
                                       : sampleOrth(A,B);
      const [segA,segB]=halfSegments(pts); const w=ch.w||8;
      const sA=styleForGate(ch.a,D,P,segA); if(sA) drawStroke(segA,sA,w);
      const sB=styleForGate(ch.b,D,P,segB); if(sB) drawStroke(segB,sB,w);
    });
  }

  /*********** Integration special (20–57 spine with A/B) ***********/
  function getAB(){
    const ch=USER_MAP.channels[key(20,57)]; if(!ch) return null;
    const P20=USER_MAP.gates[ch.a], P57=USER_MAP.gates[ch.b];
    const C=ch.ctrl || [(P20[0]+P57[0])/2,(P20[1]+P57[1])/2];
    const tA=2/3, tB=1/3; // fixed ratios you settled on
    const A=Q(P20,C,P57,tA), B=Q(P20,C,P57,tB);
    return {A,B,P20,P57,C};
  }
  function spine(t1,t2,N=120){
    const AB=getAB(); if(!AB) return [];
    const {P20,P57,C}=AB; const pts=[]; const steps=Math.max(2,Math.round(N*Math.abs(t2-t1)));
    for(let i=0;i<=steps;i++){ const t=t1+(i/steps)*(t2-t1); pts.push(Q(P20,C,P57,t)); } return pts;
  }

  function paintIntegration(D,P){
    const AB=getAB(); if(!AB) return;
    const {A,B}=AB; const P10=USER_MAP.gates['10'], P34=USER_MAP.gates['34'];
    const w=8; const s=(a,b)=>key(a,b);

    const active = new Set(Object.keys(USER_MAP.channels)); // draw when halves exist on either side; color by gate
    const has = (a,b)=> !!USER_MAP.channels[s(a,b)];

    // 20–34
    if(has(20,34)){ const seg1=spine(0.0, 1/3, 80); const s1=styleForGate(20,D,P,seg1); if(s1) drawStroke(seg1,s1,w);
                    if(P34){ const seg2=[A,P34]; const s2=styleForGate(34,D,P,seg2); if(s2) drawStroke(seg2,s2,w); } }
    // 10–20
    if(has(10,20) && P10){ const seg1=[P10,B]; const s1=styleForGate(10,D,P,seg1); if(s1) drawStroke(seg1,s1,w);
                            const seg2=spine(0.0, 1/3, 80); const s2=styleForGate(20,D,P,seg2); if(s2) drawStroke(seg2,s2,w); }
    // 57–34
    if(has(57,34)){ const seg1=spine(1.0, 2/3, 80); const s1=styleForGate(57,D,P,seg1); if(s1) drawStroke(seg1,s1,w);
                    if(P34){ const seg2=[A,P34]; const s2=styleForGate(34,D,P,seg2); if(s2) drawStroke(seg2,s2,w); } }
    // 10–57
    if(has(10,57) && P10){ const seg1=[P10,B]; const s1=styleForGate(10,D,P,seg1); if(s1) drawStroke(seg1,s1,w);
                            const seg2=spine(2/3, 1.0, 100); const s2=styleForGate(57,D,P,seg2); if(s2) drawStroke(seg2,s2,w); }
    // 20–57 full: split at midpoint between A and B
    if(has(20,57)){ const full=spine(0.0,1.0,200); const [left,right]=halfSegments(full);
                    const sL=styleForGate(20,D,P,left); if(sL) drawStroke(left,sL,w);
                    const sR=styleForGate(57,D,P,right); if(sR) drawStroke(right,sR,w); }

    // draw A–B seam mask for crisp join (hide outline at A & B)
    const mask=document.getElementById('maskSpineOutline'); while(mask.firstChild) mask.removeChild(mask.firstChild);
    const vb=(svg.getAttribute('viewBox')||'0 0 720 1080').split(/\s+/).map(parseFloat);
    el('rect',{x:vb[0],y:vb[1],width:vb[2],height:vb[3],fill:'white'}, mask);
    gCenters.querySelectorAll('.center-shape').forEach(s=>{
      const c=s.cloneNode(true); c.removeAttribute('class'); c.setAttribute('fill','black'); c.setAttribute('stroke','none'); mask.appendChild(c);
    });
    function disk(p,r){ const c=el('circle',{cx:p[0],cy:p[1],r,fill:'black',stroke:'none'}); mask.appendChild(c); }
    const outlineW=10; disk(AB.A,outlineW/2+1.5); disk(AB.B,outlineW/2+1.5);
  }

  /*********** Apply API JSON to drawing ***********/
  function applyBodygraph(json){
    // parse
    const {centersDefined,D,P} = parseApi(json);

    // base geometry
    drawCenters(); drawGates();

    // centers (fill cyan) and gates (black dots + white labels where defined)
    paintCenters(centersDefined);
    drawGatesStyled(D,P,centersDefined);

    // channels
    gChannels.innerHTML='';                 // clear
    paintNonIntegrationHalves(D,P);         // all non-integration channels
    paintIntegration(D,P);                  // integration special

    return true;
  }

  // ============== RENDER ==============
  // Initial static draw so the template appears even before JSON comes back.
  drawCenters(); drawGates(); paintChannelBaseOutlined();

  // Expose for index page navigation (if you use postMessage to send JSON in)
  window.applyBodygraph = applyBodygraph;

  // Dev: built-in sample (kept so you can test quickly by opening WORKING.html directly)
  window.__HD_EXAMPLE_JSON__ = {
    "type":"Manifestor","profile":"6/2",
    "channels_short":["25-51","7-31","20-34"],   /* includes 20-34 so you can see A–B fill */
    "centers":["Ego","G","Throat"],
    "strategy":"Inform","authority":"Ego Projected",
    "definition":"Single Definition","signature":"Peace","not_self_theme":"Anger",
    "activations":{
      "design":{ "sun":"25.2","earth":"46.2","north_node":"61.6","south_node":"62.6","moon":"20.3","mercury":"51.2","venus":"27.1","mars":"12.1","jupiter":"31.2","saturn":"41.3","uranus":"38.5","neptune":"54.2","pluto":"43.2" },
      "personality":{ "sun":"12.6","earth":"11.6","north_node":"54.5","south_node":"53.5","moon":"46.6","mercury":"15.3","venus":"33.6","mars":"7.2","jupiter":"33.5","saturn":"41.5","uranus":"38.4","neptune":"54.1","pluto":"1.6" }
    }
  };

  // Auto-render the sample if no parent posts JSON in
  try{ if(!window.__SUPPRESS_SAMPLE__) applyBodygraph(window.__HD_EXAMPLE_JSON__); }catch(_){}
  </script>
</body>
</html>
