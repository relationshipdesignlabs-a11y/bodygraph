<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Chart details</title>
  <style>
    :root{ --cyan:#00bcd4; --ink:#0a0f12; --muted:#64748b; }
    *{ box-sizing:border-box }
    html,body{ margin:0; height:100% }
    body{ background:#fff; color:var(--ink); font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap{ max-width:1100px; margin:0 auto; padding:24px; display:grid; grid-template-columns: 440px 1fr; gap:24px; align-items:start; }
    .card{ background:#fff; border:1px solid #e6eef2; border-radius:12px; padding:14px; }
    h1{ margin:0 0 12px; font-size:20px; font-weight:800; letter-spacing:.06em }
    .muted{ color:var(--muted) }
    .row{ margin:8px 0; }
    .k{ font-weight:700; width:170px; display:inline-block; }
    #chartFrame{ width:100%; height:740px; border:0; display:block; }
    #back{ display:inline-block; margin-bottom:12px; text-decoration:none; color:#111; font-weight:600 }
    .pill{ display:inline-block; padding:3px 8px; border:1px solid #e6eef2; border-radius:999px; margin:2px 6px 0 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <a id="back" href="index.html">← Back</a> <button id="dl" style="float:right;background:#111;color:#fff;border:0;border-radius:10px;padding:8px 12px;cursor:pointer">Download PNG</button>
      <h1 id="title"></h1>
      <iframe id="chartFrame" src="/WORKING.html" loading="eager"></iframe>
    </div>
    <div class="card">
      <h1>Basics</h1>
      <div class="row"><span class="k">Aura Type:</span> <span id="type"></span></div>
      <div class="row"><span class="k">Profile:</span> <span id="profile"></span></div>
      <div class="row"><span class="k">Strategy:</span> <span id="strategy"></span></div>
      <div class="row"><span class="k">Authority:</span> <span id="authority"></span></div>
      <div class="row"><span class="k">Incarnation Cross:</span> <span id="cross"></span></div>
      <div class="row"><span class="k">Defined Channels:</span> <span id="channels"></span></div>
      <div class="row"><span class="k">Definition:</span> <span id="definition"></span></div>
      <div class="row"><span class="k">Signature:</span> <span id="signature"></span></div>
      <div class="row"><span class="k">Not-self theme:</span> <span id="notself"></span></div>
    </div>
  </div>

  <script>
    // Read from sessionStorage (set by index page)
    let json = null;
    let name = '';
    try{
      json = JSON.parse(sessionStorage.getItem('hd_last_chart') || 'null');
      name = sessionStorage.getItem('hd_name') || '';
    }catch(e){}

    document.getElementById('title').textContent = name ? name : 'Chart details';

    // Populate basics (with fallbacks if fields are missing)
    const get = (k, fb='') => (json && json[k]) ? json[k] : fb;
    document.getElementById('type').textContent = get('type','—');
    document.getElementById('profile').textContent = get('profile','—');
    document.getElementById('strategy').textContent = get('strategy','—');
    document.getElementById('authority').textContent = get('authority','—');
    document.getElementById('cross').textContent = get('incarnation_cross','—');
    document.getElementById('definition').textContent = get('definition','—');
    document.getElementById('signature').textContent = get('signature','—');
    document.getElementById('notself').textContent = get('not_self_theme','—');

    const ch = (json && (json.channels_long || json.channels_short)) || [];
    const chEl = document.getElementById('channels');
    if(Array.isArray(ch) && ch.length){
      chEl.innerHTML = ch.map(s => `<span class="pill">${s}</span>`).join('');
    }else{
      chEl.textContent = '—';
    }

    // Render the smaller chart in the iframe
    (function (){
      const frame = document.getElementById('chartFrame');
      let tries=0; const onLoad = () => {
        try{
          const doc = frame.contentDocument || frame.contentWindow.document;
          // Hide dev UI inside working file just in case
          ['.section','#leftPanel','#centerPanel','#gatePanel','#channelPanel','#workspace','#modeSection','#verticalGuideSection','#dataSection','#gGrid','#gGuide','#grid','#guide','#handles','#centerline','#gCenterline','#controls','#bgfile','#showGrid','#snap','#snapStep','#showGuide','#guideX','#magnet','#centerOnGuide','#save','#load','#loadSampleBtn']
            .forEach(sel => { doc.querySelectorAll(sel).forEach(el => el.style.display='none'); });
          const svg = doc.querySelector('svg#svg'); if(svg){ svg.style.width = '100%'; svg.style.background = '#fff'; }
          const tryApply = ()=>{ try{ if(frame.contentWindow && typeof frame.contentWindow.applyBodygraph==='function'){ frame.contentWindow.applyBodygraph(json || {}); return true; } }catch(e){} return false; };
          if(!tryApply()){ const iv=setInterval(()=>{ tries++; if(tryApply() || tries>30){ clearInterval(iv); } }, 100); }
        }catch(e){ console.warn(e); }
        frame.removeEventListener('load', onLoad);
      };
      if (frame.contentDocument && frame.contentDocument.readyState === 'complete') onLoad();
      else frame.addEventListener('load', onLoad);
    })();
  
  // --- Download PNG of visible details (chart + basics + watermark) ---
  document.getElementById('dl').addEventListener('click', async ()=>{
    try{
      const frame = document.getElementById('chartFrame');
      const doc = frame.contentDocument || frame.contentWindow.document;
      const svg = doc && doc.querySelector('svg#svg');
      if(!svg){ alert('Chart not ready yet.'); return; }

      // Serialize SVG and draw to image
      const serializer = new XMLSerializer();
      const svgStr = serializer.serializeToString(svg);
      const blob = new Blob([svgStr], {type:'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const img = new Image();
      await new Promise((res, rej)=>{ img.onload = ()=>res(); img.onerror = rej; img.src = url; });

      // Canvas size (approx of page layout): left 440px for chart, right ~600px for text
      const W = 1100, H = 780;
      const canvas = document.createElement('canvas'); canvas.width = W; canvas.height = H;
      const ctx = canvas.getContext('2d');

      // Background
      ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,W,H);

      // Watermark (diagonal)
      ctx.save();
      ctx.globalAlpha = 0.08;
      ctx.translate(W/2, H/2);
      ctx.rotate(-Math.PI/6);
      ctx.font = 'bold 72px ui-sans-serif, -apple-system, Segoe UI, Roboto, Arial';
      ctx.textAlign = 'center';
      ctx.fillStyle = '#111';
      ctx.fillText('Relationship Design Labs', 0, 0);
      ctx.restore();

      // Draw chart image (scale to fit left column)
      const chartW = 440, chartH = 740;
      ctx.drawImage(img, 0, 20, chartW, chartH);
      URL.revokeObjectURL(url);

      // Draw name/title
      const name = document.getElementById('title').textContent || '';
      ctx.fillStyle = '#0a0f12';
      ctx.font = '800 22px ui-sans-serif, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText(name, 220, 32);

      // Draw Basics text on right
      const startX = 470, startY = 40, lh = 30;
      ctx.font = '800 20px ui-sans-serif, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText('Basics', startX, startY);

      ctx.font = '600 16px ui-sans-serif, -apple-system, Segoe UI, Roboto, Arial';
      const rows = [
        ['Aura Type', document.getElementById('type').textContent || '—'],
        ['Profile', document.getElementById('profile').textContent || '—'],
        ['Strategy', document.getElementById('strategy').textContent || '—'],
        ['Authority', document.getElementById('authority').textContent || '—'],
        ['Incarnation Cross', document.getElementById('cross').textContent || '—'],
        ['Defined Channels', (function(){ const el=document.getElementById('channels'); return el ? el.textContent : '—'; })()],
        ['Definition', document.getElementById('definition').textContent || '—'],
        ['Signature', document.getElementById('signature').textContent || '—'],
        ['Not-self theme', document.getElementById('notself').textContent || '—'],
      ];
      let y = startY + 2*lh;
      rows.forEach(([k,v])=>{
        ctx.font = '700 16px ui-sans-serif, -apple-system, Segoe UI, Roboto, Arial';
        ctx.fillText(k + ':', startX, y);
        ctx.font = '400 16px ui-sans-serif, -apple-system, Segoe UI, Roboto, Arial';
        wrapText(ctx, v, startX + 170, y, 430, 22);
        y += lh;
      });

      // Download
      const a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      const base = (name || 'chart').toLowerCase().replace(/\s+/g,'-');
      a.download = base + '-details.png';
      a.click();

      function wrapText(ctx, text, x, y, maxWidth, lineHeight){
        const words = String(text).split(/\s+/); let line=''; let yy=y;
        for(let n=0;n<words.length;n++){ const testLine=line+words[n]+' '; const metrics=ctx.measureText(testLine);
          if(metrics.width>maxWidth && n>0){ ctx.fillText(line, x, yy); line=words[n]+' '; yy+=lineHeight; }
          else { line=testLine; }
        }
        ctx.fillText(line, x, yy);
      }
    }catch(err){
      console.error(err);
      alert('Could not make PNG yet. Try again in a moment.');
    }
  });

</script>
</body>
</html>
