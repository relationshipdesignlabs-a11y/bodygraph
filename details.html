<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Chart details</title>
  <style>
    :root{ --cyan:#00bcd4; --ink:#0a0f12; --muted:#64748b; }
    *{ box-sizing:border-box }
    html,body{ margin:0; height:100% }
    body{ background:#fff; color:var(--ink); font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap{ max-width:1200px; margin:0 auto; padding:24px; }
    .grid{ display:grid; grid-template-columns:500px 1fr; gap:24px; align-items:start; }
    .card{ background:#fff; border:1px solid #e6eef2; border-radius:12px; padding:12px }
    #chartFrame{ width:100%; height:740px; border:0; display:block }
    h1{ margin:0; font-size:22px }
    .muted{ color:var(--muted); }
    .row{ margin:12px 0; font-size:16px }
    .k{ display:inline-block; width:170px; font-weight:700 }
    #back{ text-decoration:none; color:var(--muted) }
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:12px">
      <a id="back" href="/index.html">← Back</a>
      <div></div>
    </div>
    <div class="grid">
      <div class="card">
        <iframe id="chartFrame" src="/WORKING.html"></iframe>
      </div>
      <div>
        <h1 id="title"></h1>
        <div id="subtitle" class="muted" style="margin-top:4px; margin-bottom:12px;"></div>
        <div class="card">
          <div class="row"><span class="k">Aura Type:</span> <span id="type"></span></div>
          <div class="row"><span class="k">Profile:</span> <span id="profile"></span></div>
          <div class="row"><span class="k">Strategy:</span> <span id="strategy"></span></div>
          <div class="row"><span class="k">Authority:</span> <span id="authority"></span></div>
          <div class="row"><span class="k">UTC Time:</span> <span id="utc"></span></div>
          <div class="row"><span class="k">Incarnation Cross:</span> <span id="cross"></span></div>
          <div class="row"><span class="k">Defined Channels:</span> <span id="channels"></span></div>
          <div class="row"><span class="k">Definition:</span> <span id="definition"></span></div>
          <div class="row"><span class="k">Signature:</span> <span id="signature"></span></div>
          <div class="row"><span class="k">Not-self theme:</span> <span id="notself"></span></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const pad = n => String(n).padStart(2,'0');
    const formatUtc = (iso)=>{ try{ const d=new Date(iso); if(!isFinite(d)) return ''; return `${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())} ${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())} UTC`; }catch(e){ return ''; } };

    function sanitizeIframe(doc){
      const hide = ['.section','#leftPanel','#centerPanel','#gatePanel','#channelPanel','#workspace','#modeSection','#verticalGuideSection','#dataSection','#gGrid','#gGuide','#grid','#guide','#handles','#centerline','#gCenterline','#controls','#bgfile','#showGrid','#snap','#snapStep','#showGuide','#guideX','#magnet','#centerOnGuide','#save','#load','#loadSampleBtn'];
      hide.forEach(sel=> doc.querySelectorAll(sel).forEach(el=> el.style.display='none') );
      const svg = doc.querySelector('svg#svg'); if(svg){ svg.style.background='#fff'; }
    }

    (function init(){
      let json = {}; let name = '';
      try{ const raw = sessionStorage.getItem('hd_last_chart'); if(raw) json = JSON.parse(raw)||{}; }catch(e){}
      try{ name = sessionStorage.getItem('hd_name')||''; }catch(e){}
      document.getElementById('title').textContent = name || 'Chart details';
      const utc = json && json.birth_date_UTC ? formatUtc(json.birth_date_UTC) : '';
      document.getElementById('subtitle').textContent = utc;
      document.getElementById('utc').textContent = utc;

      // Basics
      const get = (k, def='—') => (json && (json[k]||json[k.replace(/-/g,'_')])) || def;
      document.getElementById('type').textContent = get('type');
      document.getElementById('profile').textContent = get('profile');
      document.getElementById('strategy').textContent = get('strategy');
      document.getElementById('authority').textContent = get('authority');
      document.getElementById('cross').textContent = get('incarnation_cross','—');
      const ch = (json.channels_long && json.channels_long.length) ? json.channels_long.join(' · ') :
                 (json.channels_short && json.channels_short.length) ? json.channels_short.join(' · ') : '—';
      document.getElementById('channels').textContent = ch;
      document.getElementById('definition').textContent = get('definition');
      document.getElementById('signature').textContent = get('signature');
      document.getElementById('notself').textContent = get('not_self_theme') || get('notself_theme');

      // Render chart into iframe
      const frame = document.getElementById('chartFrame');
      const onLoad = ()=>{
        const doc = frame.contentDocument || frame.contentWindow.document;
        sanitizeIframe(doc);
        let tries=0;
        const tick = setInterval(()=>{
          try{
            if(frame.contentWindow && typeof frame.contentWindow.applyBodygraph==='function'){
              frame.contentWindow.applyBodygraph(json);
              clearInterval(tick);
            }
          }catch(e){}
          if(++tries>50) clearInterval(tick);
        }, 100);
        frame.removeEventListener('load', onLoad);
      };
      if (frame.contentDocument && frame.contentDocument.readyState === 'complete') onLoad();
      else frame.addEventListener('load', onLoad);
    })();
  </script>
</body>
</html>
